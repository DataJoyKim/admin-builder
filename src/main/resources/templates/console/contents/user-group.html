<html xmlns:th="http://www.thymeleaf.org">
<script th:fragment="script">
        $( document ).ready(function() {
            console.log('version.0.0.6');
            init();
        });

        function init() {

            sheet.initSheet('jsGrid1', "100%","500px",
            [
                {name: "id", title:"ID", type: "number", width: 50, editing: false, inserting: false},
                {name: "code", title:"코드", type: "text", width: 150 },
                {name: "name", title:"명칭", type: "text", width: 200 }
            ],
            function(args) {
                selectedContent(args.item);
            });

            sheet.initSheet('userGroupUserGrid', "100%","500px",
            [
                {name: "id", title:"ID", type: "number", width: 20, editing: false, inserting: false},
                {name: "userId", title:"사용자ID", type: "text", width: 50},
                {name: "userName", title:"사용자명", type: "text", width: 100, editing: false},
                { type: "control", editButton: true, width: 30, modeSwitchButton: false }
            ],
            function(args) {},
            {
                inserting: true,
                editing: true,
                onItemInserting: function(args) {
                    insertUserGroupUser($("#id").val(), args.item);
                },
                onItemUpdated: function(args) {
                    updateUserGroupUser($("#id").val(), args.item.id, args.item);
                },
                onItemDeleting: function(args) {
                    deleteUserGroupUser($("#id").val(), args.item);
                }
            });

            sheet.initSheet('userGroupAuthorityGrid', "100%","500px",
            [
                {name: "id", title:"ID", type: "number", width: 20, editing: false, inserting: false},
                {name: "authorityId", title:"권한ID", type: "text", width: 50},
                {name: "authorityCode", title:"권한코드", type: "text", width: 100},
                {name: "authorityName", title:"권한명", type: "text", width: 100, editing: false},
                { type: "control", editButton: true, width: 30, modeSwitchButton: false }
            ],
            function(args) {},
            {
                inserting: true,
                editing: true,
                onItemInserting: function(args) {
                    insertUserGroupAuthority($("#id").val(), args.item);
                },
                onItemUpdated: function(args) {
                    updateUserGroupAuthority($("#id").val(), args.item.id, args.item);
                },
                onItemDeleting: function(args) {
                    deleteUserGroupAuthority($("#id").val(), args.item);
                }
            });

            getList();
        }

        function getList() {
            httpClient.get(`/console/api/user-group`, {},
                function(response){
                    sheet.setSheetData('jsGrid1', response);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function selectedContent(item) {
            httpClient.get(`/console/api/user-group/${item.id}`, {},
                function(response){
                    setContentData(response);
                    getUserGroupUser(item.id);
                    getUserGroupAuthority(item.id);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function isEmpty(v) {
            return (v == undefined || v == null || v == '');
        }

        function save() {
            let id = $("#id").val();

            if(isEmpty(id))
                insertContent();
            else
                updateContent(id);
        }

        function insertContent() {
            httpClient.post(`/console/api/user-group`,{},getContent(),
                function(response){
                    alert("저장완료되었습니다.");
                    getList();
                },
                function(error){
                    alert('error');
                }
            );
        }

        function updateContent(id) {
          httpClient.put(`/console/api/user-group/${id}`, {}, getContent(),
              function(response){
                  alert("저장완료되었습니다.");
                  getList();
              },
              function(error){
                  alert('error');
              }
          );
        }

        function deleteContent() {
          let id = $("#id").val();

          httpClient.delete(`/console/api/user-group/${id}`, {},
              function(response){
                  alert("삭제 처리 완료되었습니다.");
                  getList();
              },
              function(error){
                  alert('error');
              }
          );
        }

        function setContentData(response) {
            setContent({
                id:response.id,
                code:response.code,
                name:response.name
              });
        }

        function getContent() {
            return {
                id: $("#id").val(),
                code: $("#code").val(),
                name: $("#name").val()
            }
        }

        function setContent(params) {
            $("#id").val(params.id);
            $("#code").val(params.code);
            $("#name").val(params.name);
          }

          function newContent(){
            setContent({
                id:'',
                code:'',
                name:''
              });
          }


        function getUserGroupUser(userGroupId) {
            httpClient.get(`/console/api/user-group/user/${userGroupId}`, {},
                function(response){
                    for(let i=0; i<response.length; i++) {
                        response[i].userId = response[i].user.id;
                        response[i].userName = response[i].user.userName;
                    }

                    sheet.setSheetData('userGroupUserGrid', response);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function insertUserGroupUser(userGroupId, item) {
            httpClient.post(`/console/api/user-group/user`,{},
                {
                   userGroupId:userGroupId,
                   userId:item.userId
                },
                function(response){
                    alert("생성 완료되었습니다.");
                    getUserGroupUser(userGroupId);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function updateUserGroupUser(userGroupId, userGroupUserId, item) {
          httpClient.put(`/console/api/user-group/user/${userGroupUserId}`, {},
              {
                   userGroupId:userGroupId,
                   userId:item.userId
              },
              function(response){
                  alert("변경 완료되었습니다.");
                  getUserGroupUser(userGroupId);
              },
              function(error){
                  alert('error');
              }
          );
        }

        function deleteUserGroupUser(userGroupId, item) {
          httpClient.delete(`/console/api/user-group/user/${item.id}`, {},
              function(response){
                  alert("삭제 완료되었습니다.");
                  getUserGroupUser(userGroupId);
              },
              function(error){
                  alert('error');
              }
          );
        }


        function getUserGroupAuthority(userGroupId) {
            httpClient.get(`/console/api/user-group/authority/${userGroupId}`, {},
                function(response){
                    for(let i=0; i<response.length; i++) {
                        response[i].authorityId = response[i].authority.id;
                        response[i].authorityCode = response[i].authority.code;
                        response[i].authorityName = response[i].authority.name;
                    }

                    sheet.setSheetData('userGroupAuthorityGrid', response);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function insertUserGroupAuthority(userGroupId, item) {
            httpClient.post(`/console/api/user-group/authority`,{},
                {
                   userGroupId:userGroupId,
                   authorityId:item.authorityId
                },
                function(response){
                    alert("생성 완료되었습니다.");
                    getUserGroupAuthority(userGroupId);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function updateUserGroupAuthority(userGroupId, userGroupAuthorityId, item) {
          httpClient.put(`/console/api/user-group/authority/${userGroupAuthorityId}`, {},
              {
                   userGroupId:userGroupId,
                   authorityId:item.authorityId
              },
              function(response){
                  alert("변경 완료되었습니다.");
                  getUserGroupAuthority(userGroupId);
              },
              function(error){
                  alert('error');
              }
          );
        }

        function deleteUserGroupAuthority(userGroupId, item) {
          httpClient.delete(`/console/api/user-group/authority/${item.id}`, {},
              function(response){
                  alert("삭제 완료되었습니다.");
                  getUserGroupAuthority(userGroupId);
              },
              function(error){
                  alert('error');
              }
          );
        }
    </script>
<div th:fragment="view">
    <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">UserGroup</h3>
                        <div class="card-tools">
                            <mf-action-button id="search" actionName="getList()" icon="fas fa-search"></mf-action-button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="jsGrid1"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <ul class="nav nav-tabs" id="user-group-tab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="detail-tab" data-toggle="pill" href="#detail" role="tab" aria-controls="detail" aria-selected="true">사용자그룹</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="user-tab" data-toggle="pill" href="#user" role="tab" aria-controls="user" aria-selected="false">사용자</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="authority-tab" data-toggle="pill" href="#authority" role="tab" aria-controls="authority" aria-selected="false">권한 부여</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="tabContent">
                        <div class="tab-pane fade show active" id="detail" role="tabpanel" aria-labelledby="detail-tab">
                            <div class="card-header">
                                <h3 class="card-title">상세 내용</h3>
                                <div class="card-tools">
                                    <mf-action-button id="new" actionName="newContent()" icon="fas fa-plus"></mf-action-button>
                                    <mf-action-button id="save" actionName="save()" icon="fas fa-save"></mf-action-button>
                                    <mf-action-button id="delete" actionName="deleteContent()" icon="fas fa-trash"></mf-action-button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-1">
                                        <mf-text-input id="id" label="ID" enable="false"></mf-text-input>
                                    </div>
                                    <div class="col-md-3">
                                        <mf-text-input id="code" label="코드" enable="true"></mf-text-input>
                                    </div>
                                    <div class="col-md-3">
                                        <mf-text-input id="name" label="명칭" enable="true" ></mf-text-input>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="user" role="tabpanel" aria-labelledby="user-tab">
                            <div class="card-header">
                                <h3 class="card-title">사용자</h3>
                            </div>
                            <div class="card-body">
                                <div id="userGroupUserGrid"></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="authority" role="tabpanel" aria-labelledby="authority-tab">
                            <div class="card-header">
                                <h3 class="card-title">권한 부여</h3>
                            </div>
                            <div class="card-body">
                                <div id="userGroupAuthorityGrid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</html>