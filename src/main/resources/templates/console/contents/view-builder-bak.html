<html xmlns:th="http://www.thymeleaf.org">
<style th:fragment="style">
    #app-container {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    #left-panel {
      width: 200px;
      background: #f2f2f2;
      border-right: 1px solid #ccc;
      padding: 10px;
    }
    #center-panel {
      flex: 1;
      background: #fff;
      padding: 10px;
      position: relative;
    }
    #right-panel {
      width: 400px;
      background: #fafafa;
      border-left: 1px solid #ccc;
      padding: 10px;
    }
    .component-item {
      padding: 10px;
      margin-bottom: 8px;
      background: #ddd;
      cursor: grab;
      border-radius: 4px;
      z-index:1000;
    }
    .drop-area {
      width: 100%;
      height: 100%;
      border: 2px dashed #bbb;
      position: relative;
    }
    .selected {
      outline: 1px solid #007bff;
    }
    .vb-row {
        padding: 5px;
        min-height: 80px;
        height: auto;
        margin: 0 !important;
        border: 1px dashed #bbb;
    }
    .vb-card-tools {
        padding-left: 30px;
        min-width: 60px;
        width: auto;
        min-height: 30px;
        height: auto;
        border: 1px dashed #bbb;
    }
    .vb-card-body {
        padding: 2px;
        min-height: 100px;
        height: auto;
        margin: 0 !important;
        border: 1px dashed #bbb;
    }
    .vb-form {
        padding: 10px;
        min-height: 80px;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    .vb-grid {
        background-color: #ffffff;
        height: 300px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        border-radius: 8px;
        border: 2px solid #ddd;
        box-shadow: 0 2px 3px rgba(0,0,0,0.2);
    }
    .vb-layout {
        cursor: pointer;
    }
    .component-delete-btn {
        display: none;
        position: absolute;
        top: 2px;
        right: 2px;
        width: 18px;
        height: 18px;
        line-height: 16px;
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        padding: 0;
        z-index: 999;
    }
    .component {
        position: relative;
        cursor: grab;
    }
</style>
<script th:fragment="script">
    $(document).ready(function () {
        $(".component-item").draggable({ helper: "clone" });

        dndLayout();
    });

    let numberingId = {
        row:0,
        button:0,
        form:0,
        card:0,
        grid:0,
        input:0,
        cardBody:0
    }

    function getIdNumber(id) {
        let num =numberingId[id];
        numberingId[id] = num+1;
        return num+1;
    }

    function dndLayout() {
        $(".vb-layout").droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if (type === "row") {
                    appendRow($(this));
                }
            },
        });

        sortable($(".vb-layout"), ".vb-button, .vb-row");
        appendRow($(".vb-layout"));
    }

    function dndCardHeader($el) {
        $el.droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if (type === "button") {
                    appendButton($(this));
                }
            },
        });

        sortable($el, ".vb-button");
    }

    function dndCardBody($el) {
        $el.droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if (type === "form") {
                    appendForm($(this));
                }
                else if(type === "grid") {
                    appendGrid($(this));
                }
            },
        });

        sortable($el, ".vb-form, .vb-grid");
    }

    function dndForm($el) {
        $el.droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if (type === "row") {
                    appendRow($(this));
                }
            },
        });
    }

    function dndRow($el) {
        $el.droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if(type === "card") {
                    appendCard($(this));
                }
                else if (type === "text-input") {
                    appendTextInput($(this));
                }
                else if(type === "grid") {
                    appendGrid($(this));
                }
            },
        });

        sortable($el, ".vb-input, .vb-card, vb-grid");
    }

    $(document).on("click", ".component-delete-btn", function(e) {
        e.stopPropagation();
        $(this).closest(".component").remove();
    });

    $(document).on("click", ".component", function(e) {
        e.stopPropagation();

        // 이전 선택 제거
        $(".component").removeClass("selected");
        $(".component-delete-btn").hide();

        // 현재 요소 선택
        $(this).addClass("selected");
        $(this).children(".component-delete-btn").show();
    });

    function sortable($el, items) {
        $el.sortable({
            items: items,
            containment: "parent",
            tolerance: "pointer",
            placeholder: "sortable-placeholder",
            start: function(event, ui){
                ui.placeholder.css({
                    height: ui.item.outerHeight(),
                    border: "1px dashed #bbb",
                    background: "#f0f0f0"
                });
            }
        });
    }

    function appendRow($target) {
        let options = {
            id:'row' + getIdNumber('row')
        }

        let $el = row(options.id, options);
        $target.append($el);
        dndRow($el);

        setOptions($el, options);
    }

    function appendForm($target) {
        let options = {
            id:'form' + getIdNumber('form')
        }

        let $el = form(options.id, options);
        $target.append($el);
        dndForm($el);

        appendRow($el);

        setOptions($el, options);
    }

    function appendCard($target) {
        let options = {
            id:'card' + getIdNumber('card'),
            size:"col-6",
            title:"Title"
        }

        let $el = card(options.id, options);
        $target.append($el);
        dndCardHeader($el.find(".vb-card-tools"));
        sortable($el, ".vb-card-body");

        appendCardBody($el.find(".card"));

        setOptions($el, options);
    }

    function appendCardBody($target) {
        let options = {
            id:'cardBody' + getIdNumber('cardBody')
        }

        let $el = cardBody(options.id, options);
        $target.append($el);
        dndCardBody($el);

        setOptions($el, options);
    }

    function appendTextInput($target) {
        let options = {
            id:'input' + getIdNumber('input'),
            size:'col-3',
            label:'Label'
        }

        let $el = textInput(options.id, options);
        $target.append($el);

        setOptions($el, options);
    }

    function appendGrid($target) {
        let options = {
            id:'grid' + getIdNumber('grid'),
            width: "100%",
            height: "800px",
            columns:[]
        }

        let $el = grid(options.id, options);

        $target.append($el);
        setOptions($el, options);
    }

    function appendButton($target) {
        let options = {
            id:'button' + getIdNumber('button'),
            label:'Button',
            icon:'fas fa-search'
        }

        let $el = button(options.id, options);

        $target.append( $el);
        setOptions($el, options);
    }

    function setOptions($target, options) {
        $target.data('options', options);
    }

    function getOptions($target) {
        return $target.data('options');
    }
//***************************************************
//** 옵션 패널
//***************************************************

    $(document).on("click", ".vb-card", function(e) {
        e.stopPropagation();

        const $el = $(this);

        let options = getOptions($el);

        let html = ``;

        html += optionSelect('card-size', '크기', 'col-12', getSizeOption(options.size));
        html += optionInput('card-title-input', 'Card 제목', 'col-12', options.title);
        html += optionButton('card-body-add', 'Card 내용', 'col-12', '컨텐츠 영역 추가');

        $("#options").html(html);

        $("#card-size").off("change").on("change", function() {
            options.size = $(this).val();
            setOptions($el, options);
            changeSize($el, options.size);
        });

        $("#card-title-input").off("input").on("input", function() {
            options.title = $(this).val();
            setOptions($el, options);
            $el.find(".card-title").text(options.title);
        });

        $(document).off("click", "#card-body-add").on("click", "#card-body-add", function() {
            appendCardBody($el.find(".card"));
        });
    });

    $(document).on("click", ".vb-form", function(e) {
        e.stopPropagation();

        const $el = $(this);

        let options = getOptions($el);

        let html = ``;
        html += optionButton('form-row-add', 'Form 내용', 'col-12', '행 추가');

        $("#options").html(html);

        $(document).off("click", "#form-row-add").on("click", "#form-row-add", function() {
            appendRow($el);
        });
    });

    $(document).on("click", ".vb-input", function(e) {
        e.stopPropagation();

        const $el = $(this);

        let options = getOptions($el);

        let html = ``;
        html += optionSelect('input-size', '크기', 'col-12', getSizeOption(options.size));
        html += optionInput('input-label', 'Input 라벨', 'col-12', options.label);

        $("#options").html(html);

        $("#input-size").off("change").on("change", function() {
            options.size = $(this).val();
            setOptions($el, options);
            changeSize($el, options.size);
        });

        $("#input-label").off("input").on("input", function() {
            options.label = $(this).val();
            setOptions($el, options);
            $el.find(".vb-input-label").text(options.label);
        });
    });

    $(document).on("click", ".vb-button", function(e) {
        e.stopPropagation();

        const $el = $(this);

        let options = getOptions($el);

        let html = ``;
        html += optionInput('button-icon', '버튼 아이콘', 'col-12', options.icon);
        html += optionInput('button-text', '버튼 라벨', 'col-12', options.label);

        $("#options").html(html);

        $("#button-text").off("input").on("input", function() {
            options.label = $(this).val();
            setOptions($el, options);
            $el.find(".vb-button-label").text(options.label);
        });

        $("#button-icon").off("input").on("input", function() {
            $el.find("i").removeClass(options.icon);

            options.icon = $(this).val();
            setOptions($el, options);

            $el.find("i").addClass(options.icon);
        });
    });

    $(document).on("click", ".vb-layout", function(e) {
        const $el = $(this);

        let html = ``;
        html += optionButton('layout-row-add', 'Layout 내용', 'col-12', '행 추가');

        $("#options").html(html);

        $(document).off("click", "#layout-row-add").on("click", "#layout-row-add", function() {
            appendRow($el);
        });
    });

    $(document).on("click", ".vb-grid", function(e) {
        e.stopPropagation();

        const $el = $(this);

        let options = getOptions($el);

        let html = ``;
        html += `<div class="row">`;
        html += optionInput('grid-width', '넓이', 'col-6', options.width);
        html += optionInput('grid-height', '높이', 'col-6', options.height);
        html += `</div>`;
        html += `
            <div class="form-group col-12">
               <label for="grid-columns">컬럼 설정</label>
               <div style="display: flex;justify-content: flex-end;"><a id="grid-create-column" style="cursor: pointer;">+create column</a></div>
               <div id="grid-columns"></div>
            </div>
               `;

        $("#options").html(html);

        let isInit = true;

        App.grid.init('grid-columns', "100%","600px",
            [
                {width: 30, align: "center",
                    itemTemplate: function () {
                      return "<span class='drag-handle'>☰</span>";
                    }
                },
                {type: "control", editButton: false, width: 30, modeSwitchButton: false },
                {name: "name", title:"필드", type: "text", width: 100 },
                {name: "title", title:"컬럼명", type: "text", width: 100 },
                {name: "width", title:"크기", type: "text", width: 80 },
                {name: "type", title:"타입", type: "text", width: 100 }
            ],
            function(args) {},
            {
                inserting:false,
                editing:true,
                onRefreshed: function () {
                    App.grid.enableRowDrag('grid-columns',{
                        updateEvent:function() {
                            options.columns = App.grid.getData('grid-columns');
                            console.log('options.columns',options.columns);
                            setOptions($el, options);
                        }
                    });
                },
                onItemUpdated:function(args) {
                    options.columns = App.grid.getData('grid-columns');
                    setOptions($el, options);
                },
                onItemInserting:function(args) {
                    options.columns = App.grid.getData('grid-columns');
                    setOptions($el, options);
                },
                onItemDeleting:function(args) {
                    options.columns = App.grid.getData('grid-columns');
                    setOptions($el, options);
                }
            }
        );

        App.grid.setData('grid-columns', options.columns);

        $(document).off("click", "#grid-create-column").on("click", "#grid-create-column", function() {
            App.grid.insertItem("grid-columns", {
                name: "Field",
                title: "Label",
                width: 100,
                type: "text"
            });

            options.columns = App.grid.getData('grid-columns');
            setOptions($el, options);
        });

        $("#grid-width").off("input").on("input", function() {
            options.width = $(this).val();
            setOptions($el, options);
        });

        $("#grid-height").off("input").on("input", function() {
            options.height = $(this).val();
            setOptions($el, options);
        });
    });

    function getSizeOption(value) {
        let html = ``;
        for(let i=12; i>=1; i--) {
            let selected = '';
            if(value == `col-${i}`) {
                selected = 'selected';
            }

            html += `<option value="col-${i}" ${selected}>${i}</option>`;
        }

        return html;
    }

    function optionSelect(id, label, size, options) {
        return `
            <div class="form-group ${size}">
               <label for="${id}">${label}</label>
               <select type="text" class="form-control rounded-0" id="${id}">
                   ${options}
               </select>
            </div>
        `;
    }

    function optionButton(id, label, size, buttonLabel) {
        return `
            <div class="form-group ${size}">
               <label for="${id}">${label}</label>
               <div id="${id}" type="button" class="btn btn-default btn-sm form-control">
               <i class="fas fa-plus"></i>
               ${buttonLabel}
               </div>
            </div>
        `;
    }

    function optionInput(id, label, size, value) {
        return `
            <div class="form-group ${size}">
                <label for="${id}">${label}</label>
                <input type="text" class="form-control rounded-0" id="${id}" spellcheck="false" autocomplete="off" value="${value}">
            </div>
        `;
    }

    function changeSize($target, newSize) {
        $target.removeClass(function(i, cls) {
            return (cls.match(/col-\d+/g) || []).join(' ');
        });
        $target.addClass(newSize);
    }

    function getSize($target) {
        return $target.attr("class").split(/\s+/).find(cls => cls.startsWith("col-"));
    }
//***************************************************
//** 컴포넌트
//***************************************************

    function row(id, options) {
        let btnDelete = componentDeleteBtn();
        let el = `
            <div id="${id}" class="component vb-row row" >
                ${btnDelete}
            </div>
        `;

        return $(el);
    }

    function card(id, options) {
        let btnDelete = componentDeleteBtn();
        let el = `
            <div id="${id}" class="component vb-card ${options.size}">
                ${btnDelete}
                 <div class="card">
                     <div class="vb-card-header card-header">
                          <h3 class="card-title">${options.title}</h3>
                          <div class="vb-card-tools card-tools">
                          </div>
                     </div>
                 </div>
            </div>
        `;

        return $(el);
    }

    function cardBody(id, options) {
        let btnDelete = componentDeleteBtn();
        let el = `
             <div id="${id}" class="component vb-card-body card-body">
                ${btnDelete}
             </div>
        `;

        return $(el);
    }

    function textInput(id, options) {
        let btnDelete = componentDeleteBtn();
        let el = `
            <div id="${id}" class="component vb-input form-group ${options.size}">
                ${btnDelete}
                <label class="vb-input-label" for="${id}-el">${options.label}</label>
                <input type="text" class="vb-input-box form-control rounded-0" id="${id}-el" placeholder="" spellcheck="false" autocomplete="off" data-watch="true" >
            </div>
        `;

        return $(el);
    }

    function button(id, options) {
        let btnDelete = componentDeleteBtn();
        let el = `
            <div id="${id}" type="button" class="component vb-button btn btn-default btn-sm">
                ${btnDelete}
                <i class="${options.icon}"></i>
                <span class="vb-button-label">${options.label}</span>
            </div>
        `;

        return $(el);
    }

    function form(id, options) {
        let btnDelete = componentDeleteBtn();
        let el = `
            <form id="${id}" class="component vb-form form">
                ${btnDelete}
            </form>
        `;

        return $(el);
    }

    function grid(id, options) {
        let btnDelete = componentDeleteBtn();
        let el = `
            <div id="${id}" class="component vb-grid">
                ${btnDelete}
                Grid
            </div>
        `;

        return $(el);
    }

    function componentDeleteBtn() {
        return `<button class="component-delete-btn">×</button>`;
    }

//***************************************************
//** 저장
//***************************************************
    function serializeComponent($el) {
        let type;
        if($el.hasClass('vb-row')) type = 'row';
        else if($el.hasClass('vb-card')) type = 'card';
        else if($el.hasClass('vb-card-body')) type = 'card-body';
        else if($el.hasClass('vb-input')) type = 'input';
        else if($el.hasClass('vb-button')) type = 'button';
        else if($el.hasClass('vb-grid')) type = 'grid';
        else if($el.hasClass('vb-form')) type = 'form';
        else return null;

        let data = getOptions($el);
        data.type= type;

        const children = findDirectLogicalChildren($el)
                        .map(childEl =>
                            serializeComponent(childEl)
                        )
                        .filter(Boolean);

        if (children.length > 0) {
            data.children = children;
        }

        return data;
    }

    function findDirectLogicalChildren($el) {
        let result = [];

        $el.children().each(function () {
            const $child = $(this);

            if ($child.hasClass('component')) {
                result.push($child);
            }
            else {
                result = result.concat(findDirectLogicalChildren($child));
            }
        });

        return result;
    }

    function getViewData() {
        const root = $("#layout");
        const json = [];

        root.children(".component").each(function() {
            json.push(serializeComponent($(this)));
        });

        return json;
    }

    function save() {
        const json = getViewData();

        console.log(JSON.stringify(json, null, 2));
    }

//***************************************************
//** 미리보기
//***************************************************
    let initQueue = [];

    function preview() {
        initQueue = [];

        render(getViewData());

        for (let init of initQueue) {
            init();
        }
    }

    function render(data) {
        const frag = $(document.createDocumentFragment());

        const contentWrapper = $('<div>').addClass('content-wrapper');
        contentWrapper.append(renderComponent(data));
        frag.append(contentWrapper);

        $("#canvas").empty().append(frag);
    }

    function renderComponent(data) {
        if (!data) {
            return $();
        }

        const frag = $(document.createDocumentFragment());

        for (let el of data) {
            if (el.type === 'row') {
                frag.append(renderRow(el, renderComponent(el.children)));
            }
            else if (el.type === 'button') {
                frag.append(renderButton(el));
            }
            else if (el.type === 'input') {
                frag.append(renderTextInput(el));
            }
            else if (el.type === 'card-body') {
                frag.append(renderCardBody(el, renderComponent(el.children)));
            }
            else if (el.type === 'form') {
                frag.append(renderForm(el, renderComponent(el.children)));
            }
            else if (el.type === 'grid') {
                frag.append(renderGrid(el));
            }
            else if (el.type === 'card') {

                const cardHeaderEl = [];
                const cardChildEl = [];

                for (let childEl of el.children) {
                    if (childEl.type === 'card-body') cardChildEl.push(childEl);
                    else cardHeaderEl.push(childEl);
                }

                frag.append(
                    renderCard(
                        el,
                        renderComponent(cardHeaderEl),
                        renderComponent(cardChildEl)
                    )
                );
            }
        }

        return frag;
    }

    function renderRow(data, children) {
        let el = $(`
            <div id="${data.id}" class="row" >
            </div>
        `);

        if (children) {
            el.append(children);
        }

        return el;
    }

    function renderCard(data, htmlCardTools, htmlChild) {
        let el = $(`
            <div class="${data.size}">
                 <div id="${data.id}" class="card">
                     <div class="card-header">
                          <h3 class="card-title">${data.title}</h3>
                          <div class="card-tools">
                          </div>
                     </div>
                 </div>
            </div>
        `);

        if (htmlCardTools) {
            el.find(".card-tools").append(htmlCardTools);
        }

        if (htmlChild) {
            el.find(".card").append(htmlChild);
        }

        return el;
    }

    function renderCardBody(data, children) {
        let el = $(`
             <div class="card-body">
             </div>
        `);

        if (children) {
            el.append(children);
        }

        return el;
    }

    function renderTextInput(data) {
        let el = $(`
            <div class="form-group ${data.size}">
                <label for="${data.id}">${data.label}</label>
                <input type="text" class="form-control rounded-0" id="${data.id}" placeholder="" spellcheck="false" autocomplete="off" data-watch="true" >
            </div>
        `);
        return el;
    }

    function renderButton(data) {
        let el =  $(`
            <div id="${data.id}" class="btn btn-default btn-sm">
                <i class="${data.icon}"></i>
                ${data.label}
            </div>
        `);

        return el;
    }

    function renderForm(data, children) {
        let el = $(`
            <form id="${data.id}" class="form">
            </form>
        `);

        if (children) {
            el.append(children);
        }

        return el;
    }

    function renderGrid(data) {
        let el = $(`
            <div id="${data.id}">
            </div>
        `);

        initQueue.push(() => {
            let columns = data.columns;
            columns.push({ type: "control", editButton: true, width: 30, modeSwitchButton: false });
            let rowClickEvent = function(args) {}

            let options = {};
            options.inserting = App.util.stringToBoolean("false");
            options.editing = App.util.stringToBoolean("false");

            App.grid.init(data.id, data.width,data.height,columns,rowClickEvent,options);
        });

        return el;
    }

</script>
<mf-view th:fragment="view">
    <div id="app-container" style="margin:0; display:flex; height:100vh; font-family:Arial, sans-serif;">
        <div id="left-panel">
            <h3>컴포넌트</h3>
            <div class="component-item" data-type="card">Card</div>
            <div class="component-item" data-type="button">Button</div>
            <div class="component-item" data-type="text-input">Text 입력</div>
            <div class="component-item" data-type="grid">Grid</div>
            <div class="component-item" data-type="form">Form</div>
        </div>


        <div id="center-panel">
            <div class="drop-area" id="canvas">
                <div class="layout vb-layout content-wrapper" id="layout" style="min-height: 993px;">
                </div>
            </div>
        </div>


        <div id="right-panel">
            <h3>옵션 패널</h3>
            <button onclick="preview()">미리보기</button>
            <button onclick="save()">저장</button>
            <div id="options">
                컴포넌트를 선택하세요
            </div>
        </div>
    </div>
</mf-view>