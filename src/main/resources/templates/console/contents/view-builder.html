<html xmlns:th="http://www.thymeleaf.org">
<style th:fragment="style">
    #app-container {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    #left-panel {
      width: 200px;
      background: #f2f2f2;
      border-right: 1px solid #ccc;
      padding: 10px;
    }
    #center-panel {
      flex: 1;
      background: #fff;
      padding: 10px;
      position: relative;
    }
    #right-panel {
      width: 250px;
      background: #fafafa;
      border-left: 1px solid #ccc;
      padding: 10px;
    }
    .component-item {
      padding: 10px;
      margin-bottom: 8px;
      background: #ddd;
      cursor: grab;
      border-radius: 4px;
      z-index:1000;
    }
    .drop-area {
      width: 100%;
      height: 100%;
      border: 2px dashed #bbb;
      position: relative;
    }
    .selected {
      outline: 2px solid #007bff;
    }
    .vb-row {
        min-height: 80px;
        height: auto;
        margin: 0 !important;
        border: 1px dashed #bbb;
    }
    .vb-card-tools {
        padding-left: 30px;
        min-width: 60px;
        width: auto;
        min-height: 30px;
        height: auto;
        border: 1px dashed #bbb;
    }
    .vb-card-body {
        min-height: 100px;
        height: auto;
    }
    .vb-form {
        padding-bottom: 30px;
        min-height: 100px;
        height: auto;
        border: 1px dotted #f39c12;
    }
    .vb-grid {
        background-color: #ffffff;
        height: 300px;
        width: 100%;
        display: flex;
        margin: -10px;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        border-radius: 8px;
        border: 2px solid #ddd;
        box-shadow: 0 2px 3px rgba(0,0,0,0.2);
    }
    .hover-highlight {
        outline: 1px dashed #007bff;
    }
    .component-delete-btn {
        display: none;
        position: absolute;
        top: 2px;
        right: 2px;
        width: 18px;
        height: 18px;
        line-height: 16px;
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        padding: 0;
        z-index: 999;
    }
    .component {
        position: relative;
        cursor: grab;
    }
</style>
<script th:fragment="script">
    $(document).ready(function () {
        $(".component-item").draggable({ helper: "clone" });

        dndLayout();
    });

    let numberingId = {
        row:0,
        button:0,
        form:0,
        card:0,
        grid:0,
        input:0
    }

    function getIdNumber(id) {
        let num =numberingId[id];
        numberingId[id] = num+1;
        return num+1;
    }

    function dndLayout() {
        $(".vb-layout").droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if (type === "row") {
                    let $row = row(getIdNumber('row'));
                    $(this).append($row);
                    dndRow($row);
                }
            },
        });

        $(".vb-layout").sortable({
            items: ".vb-button, .vb-row",
            containment: "parent",
            tolerance: "pointer"
        });
    }

    function dndCardHeader($el) {
        $el.droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if (type === "button") {
                    $(this).append(button(getIdNumber('button')));
                }
            },
        });

        $el.sortable({
            items: ".vb-button",
            containment: "parent",
            tolerance: "pointer"
        });
    }

    function dndCardBody($el) {
        $el.droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if (type === "form") {
                    let $form = form(getIdNumber('form'));
                    $(this).append($form);
                    dndForm($form);
                }
                else if(type === "row") {
                    let $row = row(getIdNumber('row'));
                    $(this).append($row);
                    dndRow($row);
                }
            },
        });

        $el.sortable({
            items: ".vb-row",
            containment: "parent",
            tolerance: "pointer",
            placeholder: "sortable-placeholder",
            start: function(event, ui){
                ui.placeholder.css({
                    height: ui.item.outerHeight(),
                    border: "1px dashed #bbb",
                    background: "#f0f0f0"
                });
            }
        });
    }

    function dndForm($el) {
        $el.droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if (type === "row") {
                    let $row = row(getIdNumber('row'));
                    $(this).append($row);
                    dndRow($row);
                }
            },
        });
    }

    function dndRow($el) {
        $el.droppable({
            greedy: true,
            drop: function (event, ui) {
                const type = ui.draggable.data("type");
                if(type === "card") {
                    let $card = card(getIdNumber('card'));
                    $(this).append($card);
                    dndCardHeader($card.find(".vb-card-tools"));
                    dndCardBody($card.find(".vb-card-body"));
                }
                else if (type === "text-input") {
                    $(this).append(textInput(getIdNumber('input')));
                }
                else if(type === "grid") {
                    $(this).append(grid(getIdNumber('grid')));
                }
            },
        });

        $el.sortable({
            items: ".vb-input, .vb-card, vb-grid",
            containment: "parent",
            tolerance: "pointer",
            placeholder: "sortable-placeholder",
            start: function(event, ui){
                ui.placeholder.css({
                    height: ui.item.outerHeight(),
                    border: "1px dashed #bbb",
                    background: "#f0f0f0"
                });
            }
        });
    }

    $(document).on("mouseenter", ".component", function(e) {
        e.stopPropagation();
        $(this).addClass("hover-highlight");
        $(this).find(".component-delete-btn").first().show();
    });

    $(document).on("mouseleave", ".component", function(e) {
        e.stopPropagation();
        $(this).removeClass("hover-highlight");
        $(this).find(".component-delete-btn").first().hide();
    });

    $(document).on("click", ".component-delete-btn", function(e) {
        e.stopPropagation();
        $(this).closest(".component").remove();
    });

//***************************************************
//** 옵션 패널
//***************************************************

    $(document).on("click", ".vb-card", function(e) {
        e.stopPropagation();

        const $card = $(this);

        const value = $card.find(".card-title").text();

        let html = ``;
        html += `<div class="form-group col-12">`;
        html +=   `<label for="card-title-input">Card 제목</label>`;
        html +=   `<input type="text" class="form-control rounded-0" id="card-title-input" spellcheck="false" autocomplete="off" value="${value}">`;
        html += `</div>`;

        html += `<div id="card-row-add" type="button" class="btn btn-default btn-sm">`;
        html += `<i class="fas fa-plus"></i>`;
        html += `행 추가`;
        html += `</div>`;

        $("#options").html(html);

        $("#card-title-input").off("input").on("input", function() {
            const newTitle = $(this).val();
            $card.find(".card-title").text(newTitle);
        });

        $(document).off("click", "#card-row-add").on("click", "#card-row-add", function() {
            let $row = row(getIdNumber('row'));
            $card.find(".card-body").append($row);
            dndRow($row);
        });
    });

    $(document).on("click", ".vb-layout", function(e) {
        const $layout = $(this);

        let html = ``;
        html += `<div id="layout-row-add" type="button" class="btn btn-default btn-sm">`;
        html += `<i class="fas fa-plus"></i>`;
        html += `행 추가`;
        html += `</div>`;

        $("#options").html(html);

        $(document).off("click", "#layout-row-add").on("click", "#layout-row-add", function() {
            let $row = row(getIdNumber('row'));
            $layout.append($row);
            dndRow($row);
        });
    });

//***************************************************
//** 컴포넌트
//***************************************************
    function textInput(num) {
        let el = ``;
        el += `<div id="input${num}" class="component vb-input form-group col-3">`;
        el +=   componentDeleteBtn();
        el +=   `<label for="inputEl${num}">Label</label>`;
        el +=   `<input type="text" class="form-control rounded-0" id="inputEl${num}" placeholder="" spellcheck="false" autocomplete="off" data-watch="true" >`;
        el += `</div>`;

        return $(el);
    }

    function row(num) {
        let el = ``;
        el += `<div view-type="row" class="component vb-row row" id="row${num}">`;
        el += componentDeleteBtn();
        el += `</div>`;

        return $(el);
    }

    function button(num) {
        let el = ``;
        el += `<div id="button${num}" type="button" class="component vb-button btn btn-default btn-sm">`
        el += componentDeleteBtn();
        el += `<i class="fas fa-shield-alt"></i>`;
        el += `Button`;
        el += `</div>`;

        return $(el);
    }

    function card(num) {
        let el = ``;
        el += `<div class="component vb-card col-6" id="card-col${num}">`;
        el +=       componentDeleteBtn();
        el += `     <div class="card" id="card${num}">`;
        el += `         <div class="vb-card-header card-header">`;
        el += `              <h3 class="card-title">Title</h3>`;
        el += `              <div class="vb-card-tools card-tools">`;
        el += `              </div>`;
        el += `         </div>`;
        el += `         <div class="vb-card-body card-body">`;
        el += `         </div>`;
        el += `     </div>`;
        el += `</div>`;

        return $(el);
    }

    function form(num) {
        let el = ``;
        el += `<form class="component vb-form form">`;
        el += componentDeleteBtn();
        el += `</form>`;
        return $(el);
    }

    function grid(num) {
        let el = ``;
        el += `<div class="component vb-grid" id="grid${num}">`;
        el += componentDeleteBtn();
        el += `Grid`;
        el += `</div>`;
        return $(el);
    }

    function componentDeleteBtn() {
        return `<button class="component-delete-btn">×</button>`;
    }

    function checkHtml() {
        console.log($('#canvas').html());
    }
</script>
<mf-view th:fragment="view">
    <div id="app-container" style="margin:0; display:flex; height:100vh; font-family:Arial, sans-serif;">
        <div id="left-panel">
            <h3>컴포넌트</h3>
            <button onclick="checkHtml()">Html 변환</button>
            <div class="component-item" data-type="button">Button</div>
            <div class="component-item" data-type="text-input">Text 입력</div>
            <div class="component-item" data-type="card">Card</div>
            <div class="component-item" data-type="grid">Grid</div>
        </div>


        <div id="center-panel">
            <div class="drop-area" id="canvas">
                <div class="layout vb-layout content-wrapper" id="layout" style="min-height: 993px;">
                </div>
            </div>
        </div>


        <div id="right-panel">
            <h3>옵션 패널</h3>
            <div id="options">
                컴포넌트를 선택하세요
            </div>
        </div>
    </div>
</mf-view>