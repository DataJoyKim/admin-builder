<html xmlns:th="http://www.thymeleaf.org">
<style th:fragment="style">
    #app-container {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    #left-panel {
      width: 300px;
      background: white;
      border-right: 1px solid #ccc;
      padding: 10px;
    }
    #center-panel {
      flex: 1;
      background: #fff;
      padding: 10px;
      position: relative;
    }
    #right-panel {
      width: 400px;
      background: white;
      border-left: 1px solid #ccc;
      padding: 10px;
    }
    .component-row {
        display: flex;
    }
    .component-item {
      width: 90px;
      height: 100px;
      margin: 8px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      text-align: center;
      z-index:1000;
    }
    .component-item:hover {
      border: 2px solid #4a90e2;
      background: #eef5ff;
      cursor: grab;
    }
    .drop-area {
      width: 100%;
      height: 100%;
      border: 2px dashed #bbb;
      position: relative;
    }
    .selected {
      outline: 1px solid #007bff;
    }
    .component-delete-btn {
        display: none;
        position: absolute;
        top: 2px;
        right: 2px;
        width: 18px;
        height: 18px;
        line-height: 16px;
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        padding: 0;
        z-index: 999;
    }
    .component {
        position: relative;
        cursor: grab;
    }
    .drop-hover {
      border-color: blue;
      background: #eef;
    }
</style>
<mf-view th:fragment="view">
    <div id="app-container" style="margin:0; display:flex; height:100vh; font-family:Arial, sans-serif;">
        <div id="left-panel">
            <h4>오브젝트 설정</h4>
            <div class="input-group col-12">
                <input type="text" class="form-control rounded-0" id="objectCode" placeholder="오브젝트코드" spellcheck="false" autocomplete="off" data-watch="true" >
                <span class="input-group-append">
                    <button type="button" class="btn btn-default btn-flat" onclick="openPopupObject()">
                        <i class="fas fa-search"></i>
                    </button>
                </span>
            </div>
            <div class="form-group col-12">
                <button type="button" class="btn btn-primary btn-sm form-control" onclick="load()">
                    <i class="fas fa-download"></i>불러오기
                </button>
            </div>
            <div class="form-group col-12">
                <button type="button" class="btn btn-default btn-sm form-control" onclick="openPopupMenu()">
                    메뉴등록
                </button>
            </div>

            <h4>컴포넌트</h4>
            <div id="component-panel" >
                <div class="component-row">
                    <div class="component-item" data-type="component-card" >
                        <img src="/dist/img/com-card.png" width="70" height="60" >
                        <div>
                            Card
                        </div>
                    </div>
                </div>
                <div class="component-row">
                    <div class="component-item" data-type="component-form">
                        <img src="/dist/img/com-form.png" width="70" height="60" >
                        <div>
                            Form
                        </div>
                    </div>
                    <div class="component-item" data-type="component-grid">
                        <img src="/dist/img/com-grid.png" width="70" height="60" >
                        <div>
                            Grid
                        </div>
                    </div>
                </div>
                <div class="component-row">
                    <div class="component-item" data-type="component-button">
                        <img src="/dist/img/com-button.png" width="70" height="60" >
                        <div>
                            Button
                        </div>
                    </div>
                    <div class="component-item" data-type="component-input">
                        <img src="/dist/img/com-input.png" width="70" height="60" >
                        <div>
                            Input
                        </div>
                    </div>
                </div>
                <div class="component-row">
                    <div class="component-item" data-type="component-custom-html">
                        <img src="/dist/img/com-html.png" width="70" height="60" >
                        <div>
                            Html
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="center-panel">
            <div class="drop-area" id="canvas">
            </div>
        </div>


        <div id="right-panel">
            <div class="form-group col-12">
                <button type="button" class="btn btn-default btn-sm" onclick="openPopupAction()">
                    <i class="fas fa-layer-group"></i>Action 등록
                </button>
                <button type="button" class="btn btn-default btn-sm" onclick="preview()">
                    <i class="fas fa-eye"></i>미리보기
                </button>
                <button type="button" class="btn btn-default btn-sm" onclick="save()">
                    <i class="fas fa-save"></i>저장
                </button>
                <button type="button" class="btn btn-default btn-sm" onclick="reload()">
                    <i class="fas fa-redo-alt"></i>화면초기화
                </button>
            </div>
            <h4>옵션</h4>
            <div id="options">
                컴포넌트를 선택하세요
            </div>
        </div>
    </div>

    <script type="module" src="/ui/view-builder/app-editor.js"></script>
</mf-view>
<script th:fragment="script">
    $( document ).ready(function() {
        App.modalPopup.receiveParam('OBJECT_RESULT',function(data){
            if(data.objectCode) {
                $("#objectCode").val(data.objectCode);
            }
        });
    });

    function openPopupMenu() {
        App.modalPopup.open('/console/menu',{title:'메뉴 팝업',messageId:'MENU_REQUEST'});
    }

    function openPopupObject() {
        App.modalPopup.open('/console/view-object',{title:'오브젝트 팝업',messageId:'OBJECT_REQUEST'});
    }

    function openPopupAction() {
        let objectCode = $("#objectCode").val();
        if(!objectCode) {
            alert('오브젝트를 입력해주세요');
            return;
        }

        App.modalPopup.open('/console/action',{title:'Action 팝업',messageId:'ACTION_REQUEST'},{objectCode:objectCode});
    }

    function save() {
        const json = App.vb.getViewData();

        const objectCode = $("#objectCode").val();

        if(!objectCode) {
            alert("오브젝트 코드를 입력해주세요.");
            return;
        }

        App.httpClient.post(`/console/api/object-content/upsert`,{},{
                objectCode:objectCode,
                content:JSON.stringify(json, null, 2)
            },
            function(response){
                alert("저장에성공하였습니다.");
            },
            function(error){
                alert("에러가 발생되었습니다.");
            }
        );
    }

    function load() {
        const objectCode = $("#objectCode").val();

        if(!objectCode) {
            alert("오브젝트 코드를 입력해주세요.");
            return;
        }

        App.httpClient.get(`/console/api/object-content`,{objectCode:objectCode},
            function(response){
                if(response[0]) {
                    loadEditor(JSON.parse(response[0].content));
                }
                else {
                    alert('오브젝트가 존재하지않아 빈화면으로 셋팅됩니다.\n오브젝트를 생성 후 작업을 진행해주세요.');
                    loadEditor([]);
                }
            },
            function(error){
                alert("에러가 발생되었습니다.");
            }
        );
    }

    function loadEditor(data) {
        App.vb.loadEditor(data);
    }

    function preview() {
        App.vb.preview();
    }

    function reload() {
        location.reload();
    }
</script>
