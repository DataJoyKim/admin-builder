<html xmlns:th="http://www.thymeleaf.org">
<style th:fragment="style">
    #app-container {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    #left-panel {
      width: 200px;
      background: #f2f2f2;
      border-right: 1px solid #ccc;
      padding: 10px;
    }
    #center-panel {
      flex: 1;
      background: #fff;
      padding: 10px;
      position: relative;
    }
    #right-panel {
      width: 400px;
      background: #fafafa;
      border-left: 1px solid #ccc;
      padding: 10px;
    }
    .component-item {
      padding: 10px;
      margin-bottom: 8px;
      background: #ddd;
      cursor: grab;
      border-radius: 4px;
      z-index:1000;
    }
    .drop-area {
      width: 100%;
      height: 100%;
      border: 2px dashed #bbb;
      position: relative;
    }
    .selected {
      outline: 1px solid #007bff;
    }
    .vb-row {
        padding: 5px;
        min-height: 80px;
        height: auto;
        margin: 0 !important;
        border: 1px dashed #bbb;
    }
    .vb-card-tools {
        padding-left: 30px;
        min-width: 60px;
        width: auto;
        min-height: 30px;
        height: auto;
        border: 1px dashed #bbb;
    }
    .vb-card-body {
        padding: 2px;
        min-height: 100px;
        height: auto;
        margin: 0 !important;
        border: 1px dashed #bbb;
    }
    .vb-form {
        padding: 10px;
        min-height: 80px;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    .vb-grid {
        background-color: #ffffff;
        height: 300px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        border-radius: 8px;
        border: 2px solid #ddd;
        box-shadow: 0 2px 3px rgba(0,0,0,0.2);
    }
    .vb-layout {
        cursor: pointer;
    }
    .component-delete-btn {
        display: none;
        position: absolute;
        top: 2px;
        right: 2px;
        width: 18px;
        height: 18px;
        line-height: 16px;
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        padding: 0;
        z-index: 999;
    }
    .component {
        position: relative;
        cursor: grab;
    }
</style>
<mf-view th:fragment="view">
    <div id="app-container" style="margin:0; display:flex; height:100vh; font-family:Arial, sans-serif;">
        <div id="left-panel">
            <h3>컴포넌트</h3>
            <div class="component-item" data-type="component-card">Card</div>
            <div class="component-item" data-type="component-button">Button</div>
            <div class="component-item" data-type="component-input">Text 입력</div>
            <div class="component-item" data-type="component-grid">Grid</div>
            <div class="component-item" data-type="component-form">Form</div>
        </div>


        <div id="center-panel">
            <div class="drop-area" id="canvas">
                <div class="layout vb-item vb-layout content-wrapper" id="layout" style="min-height: 993px;" data-type="layout">
                </div>
            </div>
        </div>


        <div id="right-panel">
            <h3>옵션 패널</h3>
            <button onclick="preview()">미리보기</button>
            <button onclick="save()">저장</button>
            <div id="options">
                컴포넌트를 선택하세요
            </div>
        </div>
    </div>

    <script type="module" src="/ui/view-builder/app.js"></script>
</mf-view>
<script th:fragment="script">
//***************************************************
//** 저장
//***************************************************
    function serializeComponent($el) {
        let type;
        if($el.hasClass('vb-row')) type = 'row';
        else if($el.hasClass('vb-card')) type = 'card';
        else if($el.hasClass('vb-card-body')) type = 'card-body';
        else if($el.hasClass('vb-input')) type = 'input';
        else if($el.hasClass('vb-button')) type = 'button';
        else if($el.hasClass('vb-grid')) type = 'grid';
        else if($el.hasClass('vb-form')) type = 'form';
        else return null;

        let data = $el.data('options');
        data.type= type;

        const children = findDirectLogicalChildren($el)
                        .map(childEl =>
                            serializeComponent(childEl)
                        )
                        .filter(Boolean);

        if (children.length > 0) {
            data.children = children;
        }

        return data;
    }

    function findDirectLogicalChildren($el) {
        let result = [];

        $el.children().each(function () {
            const $child = $(this);

            if ($child.hasClass('component')) {
                result.push($child);
            }
            else {
                result = result.concat(findDirectLogicalChildren($child));
            }
        });

        return result;
    }

    function getViewData() {
        const root = $("#layout");
        const json = [];

        root.children(".component").each(function() {
            json.push(serializeComponent($(this)));
        });

        return json;
    }

    function save() {
        const json = getViewData();

        console.log(JSON.stringify(json, null, 2));
    }
</script>
