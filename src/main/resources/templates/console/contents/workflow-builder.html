<html xmlns:th="http://www.thymeleaf.org">
<style th:fragment="style">
    .step-item {
        position: relative;
        background-color: #ffffff;
        width: 350px;
        height: 180px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        font-size: 18px;
        border: 2px solid #ddd;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        margin-bottom:15px;
    }

    .step-message {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 6px 16px;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    .step-message-type {
        font-size: 12px;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 12px;
    }

    .step-message-id {
       font-weight: 500;
       font-size: 15px;
    }

    .step-function {
        flex: 1;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        padding: 12px 24px;
        gap: 16px;
        border-top: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
    }

    .step-tools {
        position: absolute;
        top: 5px;
        right: 5px;
    }

    .step-function-img {
        width: 70px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 4px;
    }

    .step-function-name {
        display: flex;
        flex-direction: column;
    }
</style>
<script th:fragment="script">
    App.codes = {
        "FUNCTION_TYPE":[
            {code:"ENTITY",name:"Entity"},
            {code:"SQL",name:"SQL"},
            {code:"REST_CLIENT",name:"Rest Client"}
        ],
        "YN_CD":[
            {code:"true",name:"Y"},
            {code:"false",name:"N"}
        ],
        "AUTO_VALUE_TYPE":[
            {code:"DEFAULT",name:"기본"},
            {code:"STATIC_VALUE",name:"static 값"},
            {code:"RESERVED_WORD",name:"예약어"}
        ],
        "PARAM_TYPE":[
            {code:"STRING",name:"String"},
            {code:"NUMBER",name:"Number"},
            {code:"DATE",name:"Date"}
        ],
        "IN_OUT":[
            {code:"IN",name:"IN"},
            {code:"OUT",name:"OUT"}
        ],
        "COLUMN_TYPE":[
            {code:"STRING",name:"String"},
            {code:"NUMBER",name:"Number"},
            {code:"DATE",name:"Date"},
            {code:"DATETIME",name:"Datetime"}
        ],
        "SELECT_WHERE_TYPE":[
            {code:"COMPARE_REQUIRED",name:"필수"},
            {code:"COMPARE_NOT_REQUIRED",name:"필수아님"}
        ],
        "SELECT_WHERE_COMPARE_OPERATOR":[
            {code:"=",name:"="},
            {code:"!=",name:"!="},
            {code:">",name:">"},
            {code:">=",name:">="},
            {code:"<",name:"<"},
            {code:"<=",name:"<="},
            {code:"like",name:"like"}
        ],
        "SORT_ORDER":[
            {code:"ASC",name:"오름차순"},
            {code:"DESC",name:"내림차순"}
        ],
        "NULL_RESOLVE_TYPE":[
            {code:"EXCEPTION",name:"예외처리"},
            {code:"SET_NULL",name:"null 셋팅"},
            {code:"EXCLUDE_QUERY",name:"제외"}
        ],
        "AUTO_VALUE_TYPE":[
            {code:"STATIC_VALUE",name:"static 값"},
            {code:"QUERY",name:"쿼리"},
            {code:"RESERVED_WORD",name:"예약어"}
        ]
    };

    let codes;
    let sqlEditor;

    $( document ).ready(function() {
        init();
    });

    function init() {
        setCodesDataSource();

        getWorkflowList();
        setWorkflowGrid();
        drawSqlGrid();
        drawEntityGrid();
    }

    function initCodeEditor(id,mode) {
        let textarea = document.getElementById(id);

        return CodeMirror.fromTextArea(textarea, {
            lineNumbers: true,
            lineWrapping: true,
            theme: "darcula",
            mode: mode,
            val: textarea.value
        });
    }

    function setCodesDataSource() {
        httpClient.get(`/console/api/datasource/database`, {},
            function(response){
                let codes = new Array();
                for(let i=0; i<response.length; i++) {
                    codes.push({code:response[i].dataSourceName,name:response[i].displayName});
                }

                setCodeBox("query-dataSourceName", codes);
                setCodeBox("entity-dataSourceName", codes);
            },
            function(error){
                alert('error');
            }
        );
    }

    function setCodeBox(id, _codes) {
        let codeBox = `<option value=''>선택</option>`;
        for(let code of _codes) {
            codeBox += `<option value='${code.code}'>${code.name}</option>`;
        }

        $("#"+id).html(codeBox);
    }

    function save() {
        let id = $("#workflowId").val();

        if(isEmpty(id))
            insertContent();
        else
            updateContent(id);
    }

    function selectedContent(item) {
        httpClient.get(`/console/api/workflow/${item.id}`, {},
            function(response){
                setContentData(response);
                getWorkflowFunction(item.id);
                getWorkflowAuthority(item.id);
            },
            function(error){
                alert('error');
            }
        );
    }

    function insertContent() {
        httpClient.post(`/console/api/workflow`,{},getContent(),
            function(response){
                alert("저장완료되었습니다.");
                getWorkflowList();
            },
            function(error){
                alert('error');
            }
        );
    }

    function updateContent(id) {
      httpClient.put(`/console/api/workflow/${id}`, {}, getContent(),
          function(response){
              alert("저장완료되었습니다.");
              getWorkflowList();
          },
          function(error){
              alert('error');
          }
      );
    }

    function deleteContent() {
      let id = $("#workflowId").val();

      httpClient.delete(`/console/api/workflow/${id}`, {},
          function(response){
              alert("삭제 처리 완료되었습니다.");
              getWorkflowList();
          },
          function(error){
              alert('error');
          }
      );
    }

    function setContentData(response) {
        setContent({
            id:response.id,
            workflowCode:response.workflowCode,
            displayName:response.displayName,
            note:response.note,
            useAuthValidation:String(response.useAuthValidation)
          });
    }

    function getContent() {
        return {
            id: $("#workflowId").val(),
            workflowCode: $("#workflowCode").val(),
            displayName: $("#displayName").val(),
            note: $("#note").val(),
            useAuthValidation:$("#useAuthValidation").val()
        }
    }

    function setContent(params) {
        $("#workflowId").val(params.id);
        $("#workflowCode").val(params.workflowCode);
        $("#displayName").val(params.displayName);
        $("#note").val(params.note);
        $("#useAuthValidation").val(params.useAuthValidation);
      }

      function newContent(){
        setContent({
            id:'',
            workflowCode:'',
            displayName:'',
            note:'',
            useAuthValidation:'true'
            });

        drawWorkflow('workflowGrid',[]);
        initFunctionGrid();
      }

    function getWorkflowFunction(workflowId) {
        httpClient.get(`/console/api/workflow-function`, {workflowId:workflowId},
            function(response){
                drawWorkflow('workflowGrid',response);
            },
            function(error){
                alert('error');
            }
        );
    }

    function insertWorkflowFunction(workflowId, item) {
        httpClient.post(`/console/api/workflow-function`,{},
            {
               workflowId:workflowId,
               functionName:item.functionName,
               functionType:item.functionType,
               orderNum:item.orderNum,
               isLogging:item.isLogging,
               requestMessageId:item.requestMessageId,
               responseMessageId:item.responseMessageId
            },
            function(response){
                alert("생성 완료되었습니다.");
                getWorkflowFunction(workflowId);
            },
            function(error){
                alert('error');
            }
        );
    }

    function updateWorkflowFunction(workflowId, item) {
      httpClient.put(`/console/api/workflow-function/${item.id}`, {},
          {
               workflowId:workflowId,
               functionName:item.functionName,
               functionType:item.functionType,
               orderNum:item.orderNum,
               isLogging:item.isLogging,
               requestMessageId:item.requestMessageId,
               responseMessageId:item.responseMessageId
          },
          function(response){
              alert("변경 완료되었습니다.");
              getWorkflowFunction(workflowId);
          },
          function(error){
              alert('error');
          }
      );
    }

    function deleteWorkflowFunction(workflowId, item) {
      httpClient.delete(`/console/api/workflow-function/${item.id}`, {},
          function(response){
              alert("삭제 완료되었습니다.");
              getWorkflowFunction(workflowId);
          },
          function(error){
              alert('error');
          }
      );
    }

    function saveWorkflowFunction(workflowId, items) {
      httpClient.post(`/console/api/workflow-function/save`, {},items,
          function(response){
              alert("저장완료되었습니다.");
              getWorkflowFunction(workflowId);
          },
          function(error){
              alert('error');
          }
      );
    }

    function execute() {
        let workflowCode = $("#validworkflowCode").val();
        let requestMessageId = $("#requestMessageId").val();

        let contents = {};
        let gridData = sheet.getSheetData("workflowExecute");
        console.log('gridData',gridData);
        for(let i=0; i<gridData.length; i++) {
            let value = gridData[i]["value"];
            if(value == "null") {
                contents[gridData[i]["key"]] = null;
            }
            else {
                contents[gridData[i]["key"]] = value;
            }
        }

        let body = {};
        body[requestMessageId] = contents;
        console.log('body',body);

        httpClient.post(`/workflow/${workflowCode}`,{},
            {
               body:body
            },
            function(response){
                $("#responseData").val(JSON.stringify(response,null,3));
            },
            function(error){
                alert('error');
            }
        );
    }

    function getWorkflowAuthority(workflowId) {
        httpClient.get(`/console/api/workflow-authority`, {workflowId:workflowId},
            function(response){
                sheet.setSheetData('workflowAuthorityGrid', response);
            },
            function(error){
                alert('error');
            }
        );
    }

    function insertWorkflowAuthority(workflowId, item) {
        httpClient.post(`/console/api/workflow-authority`,{},
            {
               workflowId:workflowId,
               authorityCode:item.authorityCode
            },
            function(response){
                alert("생성 완료되었습니다.");
                getWorkflowAuthority(workflowId);
            },
            function(error){
                alert('error');
            }
        );
    }

    function updateWorkflowAuthority(workflowId, item) {
      httpClient.put(`/console/api/workflow-authority/${item.id}`, {},
          {
               workflowId:workflowId,
               authorityCode:item.authorityCode
          },
          function(response){
              alert("변경 완료되었습니다.");
              getWorkflowAuthority(workflowId);
          },
          function(error){
              alert('error');
          }
      );
    }

    function deleteWorkflowAuthority(workflowId, item) {
      httpClient.delete(`/console/api/workflow-authority/${item.id}`, {},
          function(response){
              alert("삭제 완료되었습니다.");
              getWorkflowAuthority(workflowId);
          },
          function(error){
              alert('error');
          }
      );
    }
    function setWorkflowGrid() {
        $("#workflowGrid").sortable({
            axis: "y",
            cursor: "move",
            placeholder: "workflow-item-placeholder",
            tolerance: "pointer",
            items: ".step-item",
            update: function() {
                setStepItemsOrderNum();
                drawConnectors();
            }
        });

         $("<style>")
        .prop("type", "text/css")
        .html(`
          .workflow-item-placeholder {
            height: 80px;                   /* 카드 높이와 동일 */
            border: 2px dashed #007bff;     /* 테두리 강조 */
            background: #d0e7ff;            /* 배경색 */
            margin-bottom: 10px;            /* 카드 간격 맞춤 */
            border-radius: 8px;
          }
        `)
        .appendTo("head");
    }

    function setStepItemsOrderNum() {
        $("#workflowGrid .step-item").each(function(index) {
            $(this).find("input[name='orderNum']").val(index + 1);
        });
    }

    function drawWorkflow(id, response){
        let stepItemIdPrefix = 'step-item-';
        let html = '';

        for(let data of response) {
            html += htmlStepItem(stepItemIdPrefix+data.id, data, false);
        }
        html += htmlConnectLine();

        $("#"+id).html(html);

        drawConnectors();

        for(let data of response) {
            setStepItemData(stepItemIdPrefix+data.id, data);
        }
    }

    function setStepItemData(id, data) {
        $('#'+id).data('data', data);
    }

    function getStepItemData(id) {
        return $('#'+id).data('data');
    }

    function htmlConnectLine() {
        return `<svg id="connectorLayer" width="100%" height="100%" style="position:absolute; top:0; left:0; pointer-events:none;"></svg>`;
    }

    function htmlStepItem(id, data, create) {
        let iconPath = '';
        if(data.functionType == 'SQL'){
            iconPath = '/dist/img/func-sql.png';
        }
        else if(data.functionType == 'ENTITY'){
            iconPath = '/dist/img/func-entity.png';
        }
        else if(data.functionType == 'REST_CLIENT'){
            iconPath = '/dist/img/func-restclient.png';
        }

        let hiddenDisplayElement = '';
        let hiddenInputElement = 'hidden';
        let hiddenUndoBtn = 'hidden';
        let hiddenEditBtn = '';
        if(create) {
            hiddenDisplayElement = 'hidden';
            hiddenInputElement = '';
            hiddenEditBtn = 'hidden';
            hiddenUndoBtn = 'hidden';
        }

        return `
            <div class="step-item" id="${id}">
                <input type="number" name="workflowFunctionId" value="${data.id}" hidden></input>
                <input type="number" name="orderNum" value="${data.orderNum}" hidden></input>

                <!-- IN 영역 -->
                <div class="step-message" style="background-color: #e0f2ff;">
                    <span class="step-message-type" style="background-color: #bae6ff;color: #0369a1;">
                        IN
                    </span>
                    <span class="step-message-id"   style="color: #065f9e;">
                        <i class="display-element" ${hiddenDisplayElement}>${data.requestMessageId}</i>
                        <input class="input-element" type="text" name="requestMessageId" value="${data.requestMessageId}" placeholder="요청메시지ID 입력" style="width:150px;" autocomplete="off" ${hiddenInputElement}></input>
                    </span>
                </div>

                <!-- 기능 영역 -->
                <div class="step-function" onclick="clickStepItem('${data.functionType}','${data.functionName}')" >
                    <span class="step-function-img">
                        <img class="display-element" src="${iconPath}" width="70" height="70" style="display:block;" ${hiddenDisplayElement}>
                        <select class="input-element" name="functionType" style="width:80px;" ${hiddenInputElement}>
                            <option value="SQL">SQL</option>
                            <option value="ENTITY">Entity</option>
                            <option value="REST_CLIENT">Rest Client</option>
                        </select>
                    </span>
                    <span class="step-function-name">
                        <font class="display-element"  style="color: #1f2937; font-weight: 500;font-size: 18px;" ${hiddenDisplayElement}>
                            ${data.functionName}
                        </font>
                        <font class="display-element"  style="color: #1f2937; font-weight: 300;font-size: 14px;" ${hiddenDisplayElement}>
                            ${data.functionName}
                        </font>
                        <input class="input-element" type="text" name="functionName" value="${data.functionName}" placeholder="기능코드 입력" style="width:180px;" autocomplete="off" ${hiddenInputElement}></input>
                    </span>
                </div>

                <!-- OUT 영역 -->
                <div class="step-message" style="background-color: #e6f9ea;">
                    <span class="step-message-type" style="background-color: #a8f0a0;color: #047857;">
                        OUT
                    </span>
                    <span class="step-message-id"   style="color: #065f46;">
                        <i class="display-element" ${hiddenDisplayElement}>${data.responseMessageId}</i>
                        <input class="input-element" type="text" name="responseMessageId" value="${data.responseMessageId}" placeholder="응답메시지ID 입력" style="width:150px;" autocomplete="off" ${hiddenInputElement}></input>
                    </span>
                </div>

                <!-- 드래그 핸들 -->
                <span class="step-tools" style="color: #065f9e;">
                    <i class="fas fa-undo" name="btnCancel" style="cursor: pointer;" onclick="cancelEditFunction(event)" ${hiddenUndoBtn}></i>
                    <i class="fas fa-pen" name="btnEdit" style="cursor: pointer;" onclick="editFunction(event)" ${hiddenEditBtn}></i>
                    <i class="fas fa-times" name="btnDelete"  style="cursor: pointer;" onclick="deleteFunction(event)"></i>
                </span>
            </div>
        `;
    }

    function clickStepItem(functionType, functionName) {
        initFunctionGrid();

        if(functionType == "SQL") {
            showGrid('sql-card',true);
            getQuery(functionName);
        }
        else if(functionType == "ENTITY") {
            showGrid('entity-card',true);
            getEntity(functionName);
        }
    }

    function addStepItem() {
        let orderNum = getLastStepOrder()+1;

        $("#workflowGrid").append(htmlStepItem('step-item-C'+orderNum, {
            orderNum:Number(orderNum),
            functionType:"",
            functionName:"",
            requestMessageId:"",
            responseMessageId:""
        }, true));

        drawConnectors();
        initFunctionGrid();
    }

    function saveFunction() {
        if(!confirm("저장하시겠습니까?")) {
            return;
        }

        const stepItems = document.querySelectorAll('#workflowGrid .step-item');

        let workflowId = $("#workflowId").val();
        workflowId = (workflowId) ? Number(workflowId) : null;

        let items = new Array();
        for(const stepItem of stepItems) {
            const data = {};
            const fields = stepItem.querySelectorAll('input[name], select[name]');
            fields.forEach(el => (data[el.name] = el.value));
            data.id = (data.workflowFunctionId) ? Number(data.workflowFunctionId) : null;
            data.workflowId = workflowId;
            data.orderNum = (data.orderNum) ? Number(data.orderNum) : null;
            items.push(data);
        }

        saveWorkflowFunction(workflowId, items);
    }

    function deleteFunction(event) {
        if(!confirm("삭제하시겠습니까?")) {
            return;
        }

        event.stopPropagation();

        const stepItem = event.target.closest('.step-item');
        if (!stepItem) return;

        const data = {};
        const fields = stepItem.querySelectorAll('input[name], select[name]');
        fields.forEach(el => (data[el.name] = el.value));
        data.id = data.workflowFunctionId;

        if(data.workflowFunctionId) {
            deleteWorkflowFunction($("#workflowId").val(), data);
        }
        else {
            stepItem.remove();
            drawConnectors();
        }
    }

    function editFunction(event) {
        event.stopPropagation();

        const stepItem = event.target.closest('.step-item');
        if (!stepItem) return;

        const inputElements = stepItem.querySelectorAll('.input-element')
        inputElements.forEach(el => {
            el.hidden = false;
        });

        const displayElements = stepItem.querySelectorAll('.display-element')
        displayElements.forEach(el => {
            el.hidden = true;
        });

        const btnCancels = stepItem.querySelectorAll('[name="btnCancel"]');
        btnCancels.forEach(el => {
            el.hidden = false;
        });

        const btnEdits = stepItem.querySelectorAll('[name="btnEdit"]');
        btnEdits.forEach(el => {
            el.hidden = true;
        });
    }

    function cancelEditFunction(event) {
        event.stopPropagation();

        const stepItem = event.target.closest('.step-item');
        if (!stepItem) return;

        let originalData = getStepItemData(stepItem.id);
        console.log('originalData',originalData);

        const inputElements = stepItem.querySelectorAll('.input-element')
        inputElements.forEach(el => {
            el.hidden = true;
            el.value = originalData[el.name];
        });

        const displayElements = stepItem.querySelectorAll('.display-element')
        displayElements.forEach(el => {
            el.hidden = false;
        });

        const btnCancels = stepItem.querySelectorAll('[name="btnCancel"]');
        btnCancels.forEach(el => {
            el.hidden = true;
        });

        const btnEdits = stepItem.querySelectorAll('[name="btnEdit"]');
        btnEdits.forEach(el => {
            el.hidden = false;
        });
    }

    function drawConnectors() {
        const steps = document.querySelectorAll('.step-item');
        const svg = document.getElementById('connectorLayer');
        svg.innerHTML = ''; // 초기화

        steps.forEach((step, i) => {
            if(i === steps.length - 1) return; // 마지막은 연결 X

            const start = step.getBoundingClientRect();
            const end = steps[i + 1].getBoundingClientRect();
            const container = svg.getBoundingClientRect();

            const x = start.left + start.width / 2 - container.left;
            const y1 = start.bottom - container.top;
            const y2 = end.top - container.top;

            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x);
            line.setAttribute("y2", y2);
            line.setAttribute("stroke", "#bbb");
            line.setAttribute("stroke-width", "3");

            svg.appendChild(line);
        });
    }

    function getLastStepOrder() {
        const parent = document.querySelector('#workflowGrid');

        const items = parent.querySelectorAll('.step-item');
        const lastIndex = items.length;

        return lastIndex;
    }

    function initFunctionGrid() {
        showGrid('sql-card',false);
        showGrid('entity-card',false);
    }

/******************************************************************
* SQL
*******************************************************************/
    function showGrid(id, show) {
        if(show) {
            $("#"+id).removeClass('d-none');
        }
        else {
            $("#"+id).addClass('d-none');
        }
    }

    function drawSqlGrid() {
        sqlEditor = initCodeEditor('query','text/x-sql');
    }

    function getQuery(functionName) {
        httpClient.get(`/console/api/query`, {queryName:`${functionName}`},
            function(response){
                let data = response[0];
                if(data) {
                    setQueryContent(data);
                    getQueryParam(data.id);
                }
                else {
                    setQueryContent({
                        id:'',
                        queryName:functionName,
                        displayName:'',
                        dataSourceName:'',
                        query:'',
                    });
                }
            },
            function(error){
                alert('error');
            }
        );
    }

    function getQueryParam(queryId) {
        httpClient.get(`/console/api/query-param/${queryId}`, {},
            function(response){
                sheet.setSheetData('queryParameterGrid', response);
            },
            function(error){
                alert('error');
            }
        );
    }

    function setQueryContent(response) {
        setQueryContent({
            id:response.id,
            queryName:response.queryName,
            displayName:response.displayName,
            dataSourceName:response.dataSourceName,
            query:response.query
          });
    }

    function getQueryContent() {
        return {
            id: $("#query-id").val(),
            queryName: $("#query-queryName").val(),
            displayName: $("#query-displayName").val(),
            dataSourceName: $("#query-dataSourceName").val(),
            query: sqlEditor.getValue()
        }
    }

    function setQueryContent(params) {
        $("#query-id").val(params.id);
        $("#query-queryName").val(params.queryName);
        $("#query-displayName").val(params.displayName);
        $("#query-dataSourceName").val(params.dataSourceName);
        sqlEditor.setValue(params.query);
    }

    function saveQuery() {
        let id = $("#query-id").val();

        if(id) updateQuery(id);
        else insertQuery();
    }

    function insertQuery() {
        httpClient.post(`/console/api/query`,{},getQueryContent(),
            function(response){
                alert("저장완료되었습니다.");
                getQuery($("#query-queryName").val());
            },
            function(error){
                alert('error');
            }
        );
    }

    function updateQuery(id) {
      httpClient.put(`/console/api/query/${id}`, {}, getQueryContent(),
          function(response){
              alert("저장완료되었습니다.");
              getQuery($("#query-queryName").val());
          },
          function(error){
              alert('error');
          }
      );
    }

    function deleteQuery() {
      let id = $("#query-id").val();

      httpClient.delete(`/console/api/query/${id}`, {},
          function(response){
              alert("삭제 되었습니다.");
              getQuery($("#query-queryName").val());
          },
          function(error){
              alert('error');
          }
      );
    }
/******************************************************************
* Entity
*******************************************************************/

    function drawEntityGrid() {

        sheet.initSheet('entityColumnSelectGrid', "100%","500px",
        [
            {name: "id", title:"ID", type: "number", width: 20, editing: false},
            {name: "columnName", title:"column", type: "text", width: 100 , editing: false},
            {name: "selectWhereType", title:"where 유형", type: "select", width: 50, items: App.codes["SELECT_WHERE_TYPE"], valueField: "code", textField: "name" },
            {name: "selectWhereCompareOperator", title:"where 비교 연산자", type: "select", width: 50, items: App.codes["SELECT_WHERE_COMPARE_OPERATOR"], valueField: "code", textField: "name" },
            {name: "selectOrderByNum", title:"order by 순서", type: "number", width: 50},
            {name: "selectOrderBySortOrder", title:"order by 정렬유형", type: "select", width: 50, items: App.codes["SORT_ORDER"], valueField: "code", textField: "name" },
            { type: "control", editButton: true, deleteButton: false, width: 30, modeSwitchButton: false, }
        ],
        function(args) {},
        {
            inserting: false,
            editing: true,
            onItemUpdated: function(args) {
                updateEntityColumn("/select", $("#id").val(),args.item.id,
                      {
                           selectWhereType:args.item.selectWhereType,
                           selectWhereCompareOperator:args.item.selectWhereCompareOperator,
                           selectOrderByNum:args.item.selectOrderByNum,
                           selectOrderBySortOrder:args.item.selectOrderBySortOrder
                      });
            }
        });

        sheet.initSheet('entityColumnInsertGrid', "100%","500px",
        [
            {name: "id", title:"ID", type: "number", width: 20, editing: false},
            {name: "columnName", title:"column", type: "text", width: 100 , editing: false},
            {name: "insertNullResolveType", title:"null 처리유형", type: "select", width: 50, items: App.codes["NULL_RESOLVE_TYPE"], valueField: "code", textField: "name" },
            {name: "insertAutoValueType", title:"자동값 유형", type: "select", width: 50, items: App.codes["AUTO_VALUE_TYPE"], valueField: "code", textField: "name" },
            {name: "insertAutoValue", title:"자동값", type: "text", width: 100},
            { type: "control", editButton: true, deleteButton: false, width: 30, modeSwitchButton: false, }
        ],
        function(args) {},
        {
            inserting: false,
            editing: true,
            onItemUpdated: function(args) {
                updateEntityColumn("/insert", $("#id").val(),args.item.id,
                      {
                           selectWhereType:args.item.selectWhereType,
                           selectWhereCompareOperator:args.item.selectWhereCompareOperator,
                           selectOrderByNum:args.item.selectOrderByNum,
                           selectOrderBySortOrder:args.item.selectOrderBySortOrder
                      });
            }
        });

        sheet.initSheet('entityColumnUpdateGrid', "100%","500px",
        [
            {name: "id", title:"ID", type: "number", width: 20, editing: false},
            {name: "columnName", title:"column", type: "text", width: 100 , editing: false},
            {name: "updateNullResolveType", title:"null 처리유형", type: "select", width: 50, items: App.codes["NULL_RESOLVE_TYPE"], valueField: "code", textField: "name" },
            {name: "updateAutoValueType", title:"자동값 유형", type: "select", width: 50, items: App.codes["AUTO_VALUE_TYPE"], valueField: "code", textField: "name" },
            {name: "updateAutoValue", title:"자동값", type: "text", width: 100},
            { type: "control", editButton: true, deleteButton: false, width: 30, modeSwitchButton: false, }
        ],
        function(args) {},
        {
            inserting: false,
            editing: true,
            onItemUpdated: function(args) {
                updateEntityColumn("/update", $("#id").val(),args.item.id,
                      {
                           updateNullResolveType:args.item.updateNullResolveType,
                           updateAutoValueType:args.item.updateAutoValueType,
                           updateAutoValue:args.item.updateAutoValue
                      });
            }
        });

        sheet.initSheet('entityColumnDeleteGrid', "100%","500px",
        [
            {name: "id", title:"ID", type: "number", width: 20, editing: false},
            {name: "columnName", title:"column", type: "text", width: 100 , editing: false},
            {name: "deleteAutoValueType", title:"자동값 유형", type: "select", width: 50, items: App.codes["AUTO_VALUE_TYPE"], valueField: "code", textField: "name" },
            {name: "deleteAutoValue", title:"자동값", type: "text", width: 100},
            { type: "control", editButton: true, deleteButton: false, width: 30, modeSwitchButton: false, }
        ],
        function(args) {},
        {
            inserting: false,
            editing: true,
            onItemUpdated: function(args) {
                updateEntityColumn("/delete", $("#id").val(),args.item.id,
                      {
                           deleteAutoValueType:args.item.deleteAutoValueType,
                           deleteAutoValue:args.item.deleteAutoValue
                      });
            }
        });
    }

    function getEntity(entityName) {
        httpClient.get(`/console/api/entity`, {entityName:entityName},
            function(response){
                if(response[0]) {
                    setEntityContent(response[0]);
                    getEntityColumn(response[0].id);
                }
                else {
                    newEntityContent(entityName);
                }
            },
            function(error){
                alert('error');
            }
        );
    }

    function getEntityColumn(entityId) {
        httpClient.get(`/console/api/entity-column/${entityId}`, {},
            function(response){
                sheet.setSheetData('entityColumnGrid', response);
                sheet.setSheetData('entityColumnSelectGrid', response);
                sheet.setSheetData('entityColumnInsertGrid', response);
                sheet.setSheetData('entityColumnUpdateGrid', response);
                sheet.setSheetData('entityColumnDeleteGrid', response);
            },
            function(error){
                alert('error');
            }
        );
    }

    function getEntityContent() {
        return {
            id: $("#entity-id").val(),
            entityName: $("#entity-entityName").val(),
            displayName: $("#entity-displayName").val(),
            dataSourceName: $("#entity-dataSourceName").val(),
            tableName: $("#entity-tableName").val()
        }
    }

    function setEntityContent(params) {
        $("#entity-id").val(params.id);
        $("#entity-entityName").val(params.entityName);
        $("#entity-displayName").val(params.displayName);
        $("#entity-dataSourceName").val(params.dataSourceName);
        $("#entity-tableName").val(params.tableName);
      }

      function newEntityContent(entityName){
        setEntityContent({
            id:'',
            entityName:entityName,
            displayName:'',
            dataSourceName:'',
            tableName:''
            });
      }

    function saveEntity() {
      let id = $("#entity-id").val();

        if(id) updateEntityContent(id);
        else insertEntityContent();
    }

    function insertEntityContent() {
        httpClient.post(`/console/api/entity`,{},getEntityContent(),
            function(response){
                alert("저장완료되었습니다.");
                getEntity($("#entity-entityName").val());
            },
            function(error){
                alert('error');
            }
        );
    }

    function updateEntityContent(id) {
      httpClient.put(`/console/api/entity/${id}`, {}, getEntityContent(),
          function(response){
              alert("저장완료되었습니다.");
              getEntity($("#entity-entityName").val());
          },
          function(error){
              alert('error');
          }
      );
    }

    function deleteEntityContent() {
      let id = $("#entity-id").val();

      httpClient.delete(`/console/api/entity/${id}`, {},
          function(response){
              alert("삭제 처리 완료되었습니다.");
              getEntity($("#entity-entityName").val());
          },
          function(error){
              alert('error');
          }
      );
    }

    function insertEntityColumn(entityId, item) {
        httpClient.post(`/console/api/entity-column`,{},
            {
               entityId:entityId,
               columnName:item.columnName,
               displayName:item.displayName,
               useKey:item.useKey,
               columnType:item.columnType
            },
            function(response){
                alert("생성 완료되었습니다.");
                getEntityColumn(entityId);
            },
            function(error){
                alert('error');
            }
        );
    }

    function updateEntityColumn(path, entityId, entityColumnId, params) {
      httpClient.put(`/console/api/entity-column/${entityColumnId}${path}`, {},params,
          function(response){
              alert("변경 완료되었습니다.");
              getEntityColumn(entityId);
          },
          function(error){
              alert('error');
          }
      );
    }

    function deleteEntityColumn(entityId, item) {
      httpClient.delete(`/console/api/entity-column/${item.id}`, {},
          function(response){
              alert("삭제 완료되었습니다.");
              getEntityColumn(entityId);
          },
          function(error){
              alert('error');
          }
      );
    }
</script>
<mf-view th:fragment="view">
    <mf-data>
        <mf-codes>
        </mf-codes>
        <mf-messages>
            <mf-message id="ME_EVAL0001_01"></mf-message>
            <mf-message id="ME_EVAL0001_02"></mf-message>
            <mf-message id="ME_EVAL0001_03"></mf-message>
        </mf-messages>
    </mf-data>
    <mf-actions>
        <mf-action name="clickWorkflowList" args="args">
            selectedContent(args.item);
        </mf-action>

        <mf-action name="getWorkflowList" >
            httpClient.get(`/console/api/workflow`, {},
                function(response){
                    sheet.setSheetData('workflowListGrid', response);
                },
                function(error){
                    alert('조회하는데 실패하였습니다.');
                }
            );
        </mf-action>

        <mf-action name="insertQueryParam" args="args">
            let queryId = $("#query-id").val();
            let item = args.item;

            httpClient.post(`/console/api/query-param`,{},
                {
                   queryId:queryId,
                   paramName:item.paramName,
                   paramType:item.paramType,
                   autoValueType:item.autoValueType,
                   inOut:item.inOut
                },
                function(response){
                    alert("생성 완료되었습니다.");
                    getQueryParam(queryId);
                },
                function(error){
                    alert('error');
                }
            );
        </mf-action>

        <mf-action name="updateQueryParam" args="args">
            let queryId = $("#query-id").val();
            let item = args.item;

            httpClient.put(`/console/api/query-param/${item.id}`, {},
              {
                   queryId:queryId,
                   paramName:item.paramName,
                   paramType:item.paramType,
                   autoValueType:item.autoValueType,
                   inOut:item.inOut
              },
              function(response){
                  alert("변경 완료되었습니다.");
                  getQueryParam(queryId);
              },
              function(error){
                  alert('error');
              }
            );
        </mf-action>

        <mf-action name="deleteQueryParam" args="args">
            let queryId = $("#query-id").val();
            let item = args.item;

            httpClient.delete(`/console/api/query-param/${item.id}`, {},
              function(response){
                  alert("삭제 완료되었습니다.");
                  getQueryParam(queryId);
              },
              function(error){
                  alert('error');
              }
            );
        </mf-action>

        <mf-action name="insertEntityColumnEvent" args="args">
            insertEntityColumn($("#entity-id").val(), args.item);
        </mf-action>

        <mf-action name="updateEntityColumnEvent" args="args">
            updateEntityColumn("", $("#entity-id").val(),args.item.id,
            {
                columnName:args.item.columnName,
                displayName:args.item.displayName,
                useKey:args.item.useKey,
                columnType:args.item.columnType,
                orderNum:args.item.orderNum
            });
        </mf-action>

        <mf-action name="deleteEntityColumnEvent" args="args">
            deleteEntityColumn($("#entity-id").val(), args.item);
        </mf-action>

    </mf-actions>
    <mf-layout>
        <mf-row>
            <mf-col size="col-3">
                <mf-card>
                    <mf-card-header title="목록">
                        <mf-action-button id="search" actionName="getWorkflowList" icon="fas fa-search"></mf-action-button>
                    </mf-card-header>
                    <mf-card-body>
                        <mf-grid id="workflowListGrid" width="100%" height="800px"
                                 rowClickActionName="clickWorkflowList"
                        >
                            <mf-grid-column  type="number" id="id"    label="ID"      width="50px"  visible="false" ></mf-grid-column>
                            <mf-grid-column  type="text" id="workflowCode"  label="코드"   width="150px" ></mf-grid-column>
                            <mf-grid-column  type="text" id="displayName"  label="명칭"   width="200px" ></mf-grid-column>
                        </mf-grid>
                    </mf-card-body>
                </mf-card>
            </mf-col>
            <mf-col size="col-4">
                <mf-card>
                    <mf-card-header title="정의">
                        <mf-action-button id="security" actionName="security"     icon="fas fa-shield-alt"    label="접근제어"></mf-action-button>
                        <mf-action-button id="new"      actionName="newContent"     icon="fas fa-plus"          label="신규입력"></mf-action-button>
                        <mf-action-button id="save"     actionName="save"           icon="fas fa-save"          ></mf-action-button>
                        <mf-action-button id="delete"   actionName="deleteContent"  icon="fas fa-trash"         ></mf-action-button>
                    </mf-card-header>
                    <mf-card-body>
                        <mf-form id="workflowDetailForm">
                            <mf-row>
                                <mf-text-input id="workflowId"      label="ID"        enable="false"  size="col-1" hidden="true"></mf-text-input>
                                <mf-text-input id="workflowCode"    label="코드"       enable="true"   size="col-3"></mf-text-input>
                                <mf-text-input id="displayName"     label="명칭"       enable="true"   size="col-3"></mf-text-input>
                                <mf-select id="useAuthValidation"   label="인증사용"    enable="true"   size="col-2" dataProvider="YN_CD" useFirstItem="true" firstItemLabel="" firstItemValue=""></mf-select>
                            </mf-row>
                        </mf-form>
                    </mf-card-body>
                    <mf-card-header title="워크플로우">
                        <mf-action-button id="new"  actionName="addStepItem" icon="fas fa-plus" ></mf-action-button>
                        <mf-action-button id="save" actionName="saveFunction" icon="fas fa-save" ></mf-action-button>
                    </mf-card-header>
                    <mf-card-body>
                        <div id="workflowGrid" style="display:flex; flex-direction:column; gap:10px; align-items: center; justify-content: center;">
                        </div>
                    </mf-card-body>
                </mf-card>
            </mf-col>
            <mf-col size="col-5">
                <mf-card id="sql-card" hidden="true">
                    <mf-card-header title="기능">
                        <mf-action-button id="saveQuery" actionName="saveQuery" icon="fas fa-save"></mf-action-button>
                        <mf-action-button id="deleteQuery" actionName="deleteQuery" icon="fas fa-trash"></mf-action-button>
                    </mf-card-header>
                    <mf-card-body>
                        <mf-form id="sqlForm">
                            <mf-row>
                                <mf-text-input id="query-id"            label="ID"        enable="false" size="col-1" hidden="true"></mf-text-input>
                                <mf-text-input id="query-queryName"     label="쿼리명"     enable="false" size="col-3" ></mf-text-input>
                                <mf-text-input id="query-displayName"   label="화면노출명"  enable="true"  size="col-3" ></mf-text-input>
                                <mf-select id="query-dataSourceName"    label="데이터소스"  enable="true"  size="col-3"></mf-select>
                            </mf-row>
                            <mf-row>
                                <mf-col class="col-md-12">
                                    <label>SQL</label>
                                    <textarea id="query" name="query" rows="50"></textarea>
                                </mf-col>
                            </mf-row>
                            <mf-row>
                                <mf-col class="col-md-12">
                                    <mf-grid id="queryParameterGrid" width="100%" height="800px"
                                             control="true" editing="true" inserting="true"
                                             insertActionName="insertQueryParam"
                                             updateActionName="updateQueryParam"
                                             deleteActionName="deleteQueryParam"
                                    >
                                        <mf-grid-column  type="number" id="queryParameterId" label="ID"         width="20px"  hidden="true" ></mf-grid-column>
                                        <mf-grid-column  type="text"   id="paramName"        label="파라미터명"   width="80px" ></mf-grid-column>
                                        <mf-grid-column  type="select" id="paramType"        label="type"       width="50px" dataProvider="PARAM_TYPE"></mf-grid-column>
                                        <mf-grid-column  type="select" id="autoValueType"    label="자동값유형"   width="50px" dataProvider="AUTO_VALUE_TYPE" ></mf-grid-column>
                                        <mf-grid-column  type="select" id="inOut"            label="IN/OUT"     width="50px" dataProvider="IN_OUT"></mf-grid-column>
                                    </mf-grid>
                                </mf-col>
                            </mf-row>
                        </mf-form>
                    </mf-card-body>
                </mf-card>

                <mf-card id="entity-card" hidden="true">
                    <mf-card-header title="기능">
                        <mf-action-button id="save" actionName="saveEntity" icon="fas fa-save"></mf-action-button>
                        <mf-action-button id="delete" actionName="deleteEntityContent" icon="fas fa-trash"></mf-action-button>
                    </mf-card-header>
                    <mf-card-body>
                        <mf-form id="entityForm">
                            <mf-row>
                                <mf-text-input id="entity-id"           label="ID"          enable="false" size="col-1" hidden="true"></mf-text-input>
                                <mf-text-input id="entity-entityName"   label="엔티티명"      enable="false" size="col-3" ></mf-text-input>
                                <mf-text-input id="entity-displayName"  label="화면노출명"   enable="true"  size="col-3" ></mf-text-input>
                                <mf-select id="entity-dataSourceName"   label="데이터소스"    enable="true"  size="col-3" ></mf-select>
                                <mf-text-input id="entity-tableName"    label="테이블명"      enable="true"  size="col-2" ></mf-text-input>
                            </mf-row>
                        </mf-form>
                    </mf-card-body>

                    <mf-tab-group>
                        <mf-tab id="entityColumn" title="컬럼 설정" active>
                            <mf-grid id="entityColumnGrid" width="100%" height="500px"
                                     control="true" editing="true" inserting="true"
                                     insertActionName="insertEntityColumnEvent"
                                     updateActionName="updateEntityColumnEvent"
                                     deleteActionName="deleteEntityColumnEvent"
                            >
                                <mf-grid-column  type="number"   id="id"           label="ID"         width="20px"  hidden="true" ></mf-grid-column>
                                <mf-grid-column  type="text"     id="columnName"   label="컬럼명"   width="100px" ></mf-grid-column>
                                <mf-grid-column  type="text"     id="displayName"  label="화면노출명"   width="100px" ></mf-grid-column>
                                <mf-grid-column  type="checkbox" id="useKey"       label="key"   width="50px" ></mf-grid-column>
                                <mf-grid-column  type="select"   id="columnType"   label="type"       width="50px" dataProvider="COLUMN_TYPE"></mf-grid-column>
                                <mf-grid-column  type="number"   id="orderNum"     label="순서"   width="30px" ></mf-grid-column>
                            </mf-grid>
                        </mf-tab>
                        <mf-tab id="entityColumnSelect" title="select 쿼리 설정" >
                            <div id="entityColumnSelectGrid"></div>
                        </mf-tab>
                        <mf-tab id="entityColumnInsert" title="insert 쿼리 설정">
                            <div id="entityColumnInsertGrid"></div>
                        </mf-tab>
                        <mf-tab id="entityColumnUpdate" title="update 쿼리 설정">
                            <div id="entityColumnUpdateGrid"></div>
                        </mf-tab>
                        <mf-tab id="entityColumnDelete" title="delete 쿼리 설정">
                            <div id="entityColumnDeleteGrid"></div>
                        </mf-tab>
                    </mf-tab-group>
                </mf-card>
            </mf-col>
        </mf-row>
    </mf-layout>
</mf-view>
</html>