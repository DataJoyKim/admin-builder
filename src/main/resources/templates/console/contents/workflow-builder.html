<html xmlns:th="http://www.thymeleaf.org">
<script th:fragment="script">

        $( document ).ready(function() {
            init();
        });
        let codes;

        function init() {
            setWorkflowGrid();

            codes = {
                "FunctionType":[
                    {id:"ENTITY",name:"Entity"},
                    {id:"SQL",name:"SQL"},
                    {id:"REST_CLIENT",name:"Rest Client"}
                ],
                "YnCd":[
                    {id:"true",name:"Y"},
                    {id:"false",name:"N"}
                ],
                "AutoValueType":[
                    {id:"DEFAULT",name:"기본"},
                    {id:"STATIC_VALUE",name:"static 값"},
                    {id:"RESERVED_WORD",name:"예약어"}
                ]
                ,"ParamType":[
                    {id:"STRING",name:"String"},
                    {id:"NUMBER",name:"Number"},
                    {id:"DATE",name:"Date"}
                ]
                ,"InOut":[
                    {id:"IN",name:"IN"},
                    {id:"OUT",name:"OUT"}
                ]
            };

            setCodes(codes);

            sheet.initSheet('jsGrid1', "100%","600px",
            [
                {name: "id", title:"ID", type: "number", width: 50 },
                {name: "workflowCode", title:"코드", type: "text", width: 150 },
                {name: "displayName", title:"명칭", type: "text", width: 200 }
            ],
            function(args) {
                selectedContent(args.item);
                $("#validWorkflowCode").val(args.item.workflowCode);
                sheet.setSheetData('workflowExecute', [{"key":"_seq","value":"1"},{"key":"_status","value":"R"}]);
            });

            sheet.initSheet('workflowExecute', "300px","300px",
            [
                {name: "key", title:"key", type: "text", width: 100},
                {name: "value", title:"value", type: "text", width: 100},
                { type: "control", editButton: false, width: 30, modeSwitchButton: false }
            ],
            function(args) {},
            {
                inserting: true,
                editing: true,
                onItemInserting: function(args) {
                },
                onItemUpdated: function(args) {
                },
                onItemDeleting: function(args) {
                }
            });

            sheet.initSheet('workflowAuthorityGrid', "100%","500px",
            [
                {name: "id", title:"ID", type: "number", width: 20, editing: false, inserting: false},
                {name: "authorityCode", title:"권한코드", type: "text", width: 150},
                { type: "control", editButton: true, width: 30, modeSwitchButton: false }
            ],
            function(args) {},
            {
                inserting: true,
                editing: true,
                onItemInserting: function(args) {
                    insertWorkflowAuthority($("#id").val(), args.item);
                },
                onItemUpdated: function(args) {
                    updateWorkflowAuthority($("#id").val(),args.item);
                },
                onItemDeleting: function(args) {
                    deleteWorkflowAuthority($("#id").val(), args.item);
                }
            });

            getWorkflow();
        }

        function setCodes(codes) {
            setCodeBox("useAuthValidation", codes["YnCd"]);
        }

        function initCodeEditor(id,mode) {
            let textarea = document.getElementById(id);

            return CodeMirror.fromTextArea(textarea, {
                lineNumbers: true,
                lineWrapping: true,
                theme: "darcula",
                mode: mode,
                val: textarea.value
            });
        }

        function save() {
            let id = $("#id").val();

            if(isEmpty(id))
                insertContent();
            else
                updateContent(id);
        }

        function getWorkflow() {
            httpClient.get(`/console/api/workflow`, {},
                function(response){
                    sheet.setSheetData('jsGrid1', response);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function selectedContent(item) {
            httpClient.get(`/console/api/workflow/${item.id}`, {},
                function(response){
                    setContentData(response);
                    getWorkflowFunction(item.id);
                    getWorkflowAuthority(item.id);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function insertContent() {
            httpClient.post(`/console/api/workflow`,{},getContent(),
                function(response){
                    alert("저장완료되었습니다.");
                    getWorkflow();
                },
                function(error){
                    alert('error');
                }
            );
        }

        function updateContent(id) {
          httpClient.put(`/console/api/workflow/${id}`, {}, getContent(),
              function(response){
                  alert("저장완료되었습니다.");
                  getWorkflow();
              },
              function(error){
                  alert('error');
              }
          );
        }

        function deleteContent() {
          let id = $("#id").val();

          httpClient.delete(`/console/api/workflow/${id}`, {},
              function(response){
                  alert("삭제 처리 완료되었습니다.");
                  getWorkflow();
              },
              function(error){
                  alert('error');
              }
          );
        }

        function setContentData(response) {
            setContent({
                id:response.id,
                workflowCode:response.workflowCode,
                displayName:response.displayName,
                note:response.note,
                useAuthValidation:String(response.useAuthValidation)
              });
        }

        function getContent() {
            return {
                id: $("#id").val(),
                workflowCode: $("#workflowCode").val(),
                displayName: $("#displayName").val(),
                note: $("#note").val(),
                useAuthValidation:$("#useAuthValidation").val()
            }
        }

        function setContent(params) {
            $("#id").val(params.id);
            $("#workflowCode").val(params.workflowCode);
            $("#displayName").val(params.displayName);
            $("#note").val(params.note);
            $("#useAuthValidation").val(params.useAuthValidation);
          }

          function newContent(){
            setContent({
                id:'',
                workflowCode:'',
                displayName:'',
                note:'',
                useAuthValidation:''
                });
          }

        function getWorkflowFunction(workflowId) {
            httpClient.get(`/console/api/workflow-function`, {workflowId:workflowId},
                function(response){
                    drawWorkflow('workflowGrid',response);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function insertWorkflowFunction(workflowId, item) {
            httpClient.post(`/console/api/workflow-function`,{},
                {
                   workflowId:workflowId,
                   functionName:item.functionName,
                   functionType:item.functionType,
                   orderNum:item.orderNum,
                   isLogging:item.isLogging,
                   requestMessageId:item.requestMessageId,
                   responseMessageId:item.responseMessageId
                },
                function(response){
                    alert("생성 완료되었습니다.");
                    getWorkflowFunction(workflowId);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function updateWorkflowFunction(workflowId, item) {
          httpClient.put(`/console/api/workflow-function/${item.id}`, {},
              {
                   workflowId:workflowId,
                   functionName:item.functionName,
                   functionType:item.functionType,
                   orderNum:item.orderNum,
                   isLogging:item.isLogging,
                   requestMessageId:item.requestMessageId,
                   responseMessageId:item.responseMessageId
              },
              function(response){
                  alert("변경 완료되었습니다.");
                  getWorkflowFunction(workflowId);
              },
              function(error){
                  alert('error');
              }
          );
        }

        function deleteWorkflowFunction(workflowId, item) {
          httpClient.delete(`/console/api/workflow-function/${item.id}`, {},
              function(response){
                  alert("삭제 완료되었습니다.");
                  getWorkflowFunction(workflowId);
              },
              function(error){
                  alert('error');
              }
          );
        }

        function execute() {
            let workflowCode = $("#validworkflowCode").val();
            let requestMessageId = $("#requestMessageId").val();

            let contents = {};
            let gridData = sheet.getSheetData("workflowExecute");
            console.log('gridData',gridData);
            for(let i=0; i<gridData.length; i++) {
                let value = gridData[i]["value"];
                if(value == "null") {
                    contents[gridData[i]["key"]] = null;
                }
                else {
                    contents[gridData[i]["key"]] = value;
                }
            }

            let body = {};
            body[requestMessageId] = contents;
            console.log('body',body);

            httpClient.post(`/workflow/${workflowCode}`,{},
                {
                   body:body
                },
                function(response){
                    $("#responseData").val(JSON.stringify(response,null,3));
                },
                function(error){
                    alert('error');
                }
            );
        }

        function getWorkflowAuthority(workflowId) {
            httpClient.get(`/console/api/workflow-authority`, {workflowId:workflowId},
                function(response){
                    sheet.setSheetData('workflowAuthorityGrid', response);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function insertWorkflowAuthority(workflowId, item) {
            httpClient.post(`/console/api/workflow-authority`,{},
                {
                   workflowId:workflowId,
                   authorityCode:item.authorityCode
                },
                function(response){
                    alert("생성 완료되었습니다.");
                    getWorkflowAuthority(workflowId);
                },
                function(error){
                    alert('error');
                }
            );
        }

        function updateWorkflowAuthority(workflowId, item) {
          httpClient.put(`/console/api/workflow-authority/${item.id}`, {},
              {
                   workflowId:workflowId,
                   authorityCode:item.authorityCode
              },
              function(response){
                  alert("변경 완료되었습니다.");
                  getWorkflowAuthority(workflowId);
              },
              function(error){
                  alert('error');
              }
          );
        }

        function deleteWorkflowAuthority(workflowId, item) {
          httpClient.delete(`/console/api/workflow-authority/${item.id}`, {},
              function(response){
                  alert("삭제 완료되었습니다.");
                  getWorkflowAuthority(workflowId);
              },
              function(error){
                  alert('error');
              }
          );
        }
        function setWorkflowGrid() {
            $("#workflowGrid").sortable({
                axis: "y",
                cursor: "move",
                placeholder: "workflow-item-placeholder",
                tolerance: "pointer",
                items: ".step-item",
                update: function() {
                    drawConnectors();
                }
            });

             $("<style>")
            .prop("type", "text/css")
            .html(`
              .workflow-item-placeholder {
                height: 80px;                   /* 카드 높이와 동일 */
                border: 2px dashed #007bff;     /* 테두리 강조 */
                background: #d0e7ff;            /* 배경색 */
                margin-bottom: 10px;            /* 카드 간격 맞춤 */
                border-radius: 8px;
              }
            `)
            .appendTo("head");
        }

        function drawWorkflow(id, response){
            let html = '';
            for(let data of response) {
                html += htmlStepItem(data);
            }
            html += htmlConnectLine();

            $("#"+id).html(html);

            drawConnectors();
        }

        function clickStepItem(functionType) {
            initFunctionGrid();

            if(functionType == "SQL") {
                drawSqlGrid();
            }
        }

        function addStepItem() {
            $("#workflowGrid").append(htmlStepItem({
                functionType:"SQL",
                functionName:"FRM0001_R01",
                requestMessageId:"ME_FRM0001_01",
                responseMessageId:"ME_FRM0001_02"
            }));

            drawConnectors();
        }

        function htmlConnectLine() {
            return `<svg id="connectorLayer" width="100%" height="100%" style="position:absolute; top:0; left:0; pointer-events:none;"></svg>`;
        }

        function htmlStepItem(data) {
            let iconPath = '';
            if(data.functionType == 'SQL'){
                iconPath = '/dist/img/func-sql.png';
            }
            else if(data.functionType == 'ENTITY'){
                iconPath = '/dist/img/func-entity.png';
            }
            else if(data.functionType == 'REST_CLIENT'){
                iconPath = '/dist/img/func-restclient.png';
            }

            return `
                <div class="step-item" id="${data.functionName}" onclick="clickStepItem('${data.functionType}')" style="position: relative; background-color: #ffffff; width: 350px; height: 170px; border-radius: 8px; display: flex; flex-direction: column; font-size: 18px; border: 2px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;margin-bottom:15px;">

                    <!-- IN 영역 -->
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; background-color: #e0f2ff; padding: 6px 16px; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                        <span style="background-color: #bae6ff; color: #0369a1; font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 12px;">IN</span>
                        <span style="color: #065f9e; font-weight: 500; font-size: 15px;">${data.requestMessageId}</span>
                    </div>

                    <!-- 기능 영역 -->
                    <div style="flex: 1; display: flex; flex-direction: row; align-items: center; justify-content: flex-start; padding: 12px 24px;gap: 16px; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;">
                        <span style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; margin-bottom: 4px;">
                            <img src="${iconPath}" width="70" height="70" style="display:block;">
                        </span>
                        <span style="display: flex; flex-direction: column;">
                            <font style="color: #1f2937; font-weight: 500;font-size: 18px;">
                                ${data.functionName}
                            </font>
                            <font style="color: #1f2937; font-weight: 300;font-size: 14px;">
                                ${data.functionName}
                            </font>
                        </span>
                    </div>

                    <!-- OUT 영역 -->
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; background-color: #e6f9ea; padding: 6px 16px; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;">
                        <span style="background-color: #a8f0a0; color: #047857; font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 12px;">OUT</span>
                        <span style="color: #065f46; font-weight: 500; font-size: 15px;">${data.responseMessageId}</span>
                    </div>

                    <!-- 드래그 핸들 -->
                    <span class="handle" style="position: absolute; top: 5px; right: 5px; cursor: grab; font-size: 20px;">⠿</span>
                </div>
            `;
        }

        function drawConnectors() {
            const steps = document.querySelectorAll('.step-item');
            const svg = document.getElementById('connectorLayer');
            svg.innerHTML = ''; // 초기화

            steps.forEach((step, i) => {
                if(i === steps.length - 1) return; // 마지막은 연결 X

                const start = step.getBoundingClientRect();
                const end = steps[i + 1].getBoundingClientRect();
                const container = svg.getBoundingClientRect();

                const x = start.left + start.width / 2 - container.left;
                const y1 = start.bottom - container.top;
                const y2 = end.top - container.top;

                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x);
                line.setAttribute("y1", y1);
                line.setAttribute("x2", x);
                line.setAttribute("y2", y2);
                line.setAttribute("stroke", "#bbb");
                line.setAttribute("stroke-width", "3");

                svg.appendChild(line);
            });
        }

        function drawSqlGrid() {
            let html = `
                    <div class="row">
                        <div class="col-md-1" style="display:none;">
                            <mf-text-input id="id" label="ID" enable="false"></mf-text-input>
                        </div>
                        <div class="col-md-3">
                            <mf-text-input id="queryName" label="query 명" enable="true"></mf-text-input>
                        </div>
                        <div class="col-md-3">
                            <mf-text-input id="displayName" label="화면 노출명" enable="true" ></mf-text-input>
                        </div>
                        <div class="col-md-3">
                            <mf-select id="dataSourceName" label="dataSource" enable="true" useFirstItem="true" firstItemLabel="" firstItemValue=""></mf-select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <label>SQL</label>
                            <textarea id="query" name="query" rows="50"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div id="queryParameterGrid"></div>
                        </div>
                    </div>
            `;

            $("#functionGrid").html(html);
            sqlEditor = initCodeEditor('query','text/x-sql');

            sheet.initSheet('queryParameterGrid', "100%","300px",
            [
                {name: "id", title:"ID", type: "number", width: 20, editing: false, inserting: false},
                {name: "paramName", title:"파라미터명", type: "text", width: 80 },
                {name: "paramType", title:"type", type: "select", width: 50, items: codes["ParamType"], valueField: "id", textField: "name" },
                {name: "autoValueType", title:"자동값유형", type: "select", width: 50, items: codes["AutoValueType"], valueField: "id", textField: "name" },
                {name: "inOut", title:"IN/OUT", type: "select", width: 50, items: codes["InOut"], valueField: "id", textField: "name" },
                { type: "control", editButton: true, width: 30, modeSwitchButton: false }
            ],
            function(args) {},
            {
                inserting: true,
                editing: true,
                onItemInserting: function(args) {
                    insertQueryParam($("#id").val(), args.item);
                },
                onItemUpdated: function(args) {
                    updateQueryParam($("#id").val(),args.item);
                },
                onItemDeleting: function(args) {
                    deleteQueryParam($("#id").val(), args.item);
                }
            });
        }

        function initFunctionGrid() {
            $("#functionGrid").html('');
        }

    </script>
<div th:fragment="view">
    <div class="row">
        <div class="col-3">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">워크플로우 목록</h3>
                    <div class="card-tools">
                        <mf-action-button id="search" actionName="getWorkflow()" icon="fas fa-search"></mf-action-button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="jsGrid1"></div>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">정의</h3>
                    <div class="card-tools">
                        <mf-action-button id="new" actionName="newContent()" icon="fas fa-plus"></mf-action-button>
                        <mf-action-button id="save" actionName="save()" icon="fas fa-save"></mf-action-button>
                        <mf-action-button id="delete" actionName="deleteContent()" icon="fas fa-trash"></mf-action-button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-1" style="display:none;">
                            <mf-text-input id="id" label="ID" enable="false" ></mf-text-input>
                        </div>
                        <div class="col-md-3">
                            <mf-text-input id="workflowCode" label="코드" enable="true"></mf-text-input>
                        </div>
                        <div class="col-md-3">
                            <mf-text-input id="displayName" label="명칭" enable="true" ></mf-text-input>
                        </div>
                        <div class="col-md-2">
                            <mf-select id="useAuthValidation" label="인증사용" enable="true" useFirstItem="true" firstItemLabel="" firstItemValue=""></mf-select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">워크플로우</h3>
                    <div class="card-tools">
                        <mf-action-button id="new" actionName="addStepItem()" icon="fas fa-plus"></mf-action-button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="workflowGrid" style="display:flex; flex-direction:column; gap:10px; align-items: center; justify-content: center;">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-5">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">기능</h3>
                    <div class="card-tools">
                        <mf-action-button id="save" actionName="save()" icon="fas fa-save"></mf-action-button>
                    </div>
                </div>
                <div class="card-body" id="functionGrid"></div>
            </div>
        </div>
    </div>
</div>
</html>